!function(a,b,c){function d(){var a=f++;return a in i?d():a}function e(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)b[c]=e(a[c]);return b}var f,g,h,i,j,k,l,m,n,o,p=function(a){return new p.fn.init(a)};initState=function(){f=1,h={},i={},j={},k=[],m=Array.prototype.slice,n=/\s*,\s*/,o=/\s+/},initState(),p.fn=p.prototype={init:function(a){if("string"!=typeof a)return a||(a=0,a in i||(i[a]=this)),a in i?(this[0]=a,this.length=1,this.__c||(this.__c={}),i[a]||(i[a]=this),i[a]):(this.length=0,this);var b,c,d,e,f,g,j,k=0,l=!1,m=!1;if("*"===a){g=0;for(b in i)this[g]=+b,g++;return this.length=g,1===g?i[this[0]]:this}a.indexOf(",")!==-1?(m=!0,d=n):a.indexOf(" ")!==-1&&(l=!0,d=o);for(b in i)if(i.hasOwnProperty(b))if(c=i[b],l||m){for(e=a.split(d),g=0,j=e.length,f=0;g<j;g++)c.__c[e[g]]&&f++;(l&&f===j||m&&f>0)&&(this[k++]=+b)}else c.__c[a]&&(this[k++]=+b);if(k>0&&!l&&!m&&this.extend(h[a]),e&&l)for(g=0;g<j;g++)this.extend(h[e[g]]);return this.length=k,1===k?i[this[k-1]]:this},setName:function(a){var b=String(a);return this._entityName=b,this.trigger("NewEntityName",b),this},addComponent:function(a){var b,c,d,e,f=[],g=0,i=0;if(arguments.length>1)for(c=arguments.length;i<c;i++)f.push(arguments[i]);else if(a.indexOf(",")!==-1)for(d=a.split(n),c=d.length;i<c;i++)f.push(d[i]);else f.push(a);for(b=f.length;g<b;g++)1!=this.__c[f[g]]&&(this.__c[f[g]]=!0,e=h[f[g]],this.extend(e),e&&"init"in e&&e.init.call(this));return this.trigger("NewComponent",f),this},toggleComponent:function(a){var b,c,d=0;if(arguments.length>1)for(b=arguments.length;d<b;d++)this.has(arguments[d])?this.removeComponent(arguments[d]):this.addComponent(arguments[d]);else if(a.indexOf(",")!==-1)for(c=a.split(n),b=c.length;d<b;d++)this.has(c[d])?this.removeComponent(c[d]):this.addComponent(c[d]);else this.has(a)?this.removeComponent(a):this.addComponent(a);return this},requires:function(a){for(var b,c=a.split(n),d=0,e=c.length;d<e;++d)b=c[d],this.has(b)||this.addComponent(b);return this},removeComponent:function(a,b){var c=h[a];if(this.trigger("RemoveComponent",a),c&&"remove"in c&&c.remove.call(this,!1),b===!1&&c)for(var d in c)delete this[d];return delete this.__c[a],this},getId:function(){return this[0]},has:function(a){return!!this.__c[a]},attr:function(a,b){if(1===arguments.length)return"string"==typeof a?this[a]:(this.extend(a),this.trigger("Change",a),this);this[a]=b;var c={};return c[a]=b,this.trigger("Change",c),this},toArray:function(){return m.call(this,0)},timeout:function(a,b){return this.each(function(){var c=this;setTimeout(function(){a.call(c)},b)}),this},bind:function(a,b){if(1===this.length){j[a]||(j[a]={});var c=j[a];return c[this[0]]||(c[this[0]]=[]),c[this[0]].push(b),this}return this.each(function(){j[a]||(j[a]={});var c=j[a];c[this[0]]||(c[this[0]]=[]),c[this[0]].push(b)}),this},uniqueBind:function(a,b){this.unbind(a,b),this.bind(a,b)},one:function(a,b){var c=this,d=function(e){b.call(c,e),c.unbind(a,d)};return c.bind(a,d)},unbind:function(a,b){return this.each(function(){var c,d,e=j[a],f=0;if(!e||!e[this[0]])return this;if(c=e[this[0]].length,!b)return delete e[this[0]],this;for(;f<c;f++)d=e[this[0]],d[f]==b&&delete d[f]}),this},trigger:function(a,b){if(1===this.length){if(j[a]&&j[a][this[0]]){var c,d=j[a][this[0]];for(c=0;c<d.length;c++)"undefined"==typeof d[c]?(d.splice(c,1),c--):d[c].call(this,b)}return this}return this.each(function(){if(j[a]&&j[a][this[0]]){var c,d=j[a][this[0]];for(c=0;c<d.length;c++)"undefined"==typeof d[c]?(d.splice(c,1),c--):d[c].call(this,b)}}),this},each:function(a){for(var b=0,c=this.length;b<c;b++)i[this[b]]&&a.call(i[this[b]],b);return this},clone:function(){var a,b,c=this.__c,d=p.e();for(a in c)d.addComponent(a);for(b in this)"0"!=b&&"_global"!=b&&"_changed"!=b&&"function"!=typeof this[b]&&"object"!=typeof this[b]&&(d[b]=this[b]);return d},setter:function(a,b){return p.support.setter?this.__defineSetter__(a,b):p.support.defineProperty?Object.defineProperty(this,a,{set:b,configurable:!0}):l.push({prop:a,obj:this,fn:b}),this},destroy:function(){this.each(function(){var a;this.trigger("Remove");for(var b in this.__c)a=h[b],a&&"remove"in a&&a.remove.call(this,!0);for(var c in j)this.unbind(c);delete i[this[0]]})}},p.fn.init.prototype=p.fn,p.extend=p.fn.extend=function(a){var b,c=this;if(!a)return c;for(b in a)c!==a[b]&&(c[b]=a[b]);return c},p.extend({init:function(a,b,c){return p.viewport.init(a,b,c),this.trigger("Load"),this.timer.init(),this},getVersion:function(){return"0.5.3"},stop:function(c){if(this.timer.stop(),c){if(p.audio.remove(),p.stage&&p.stage.elem.parentNode){var d=document.createElement("div");d.id=p.stage.elem.id,p.stage.elem.parentNode.replaceChild(d,p.stage.elem)}initState(),b(p,a,a.document)}return p.trigger("CraftyStop"),this},pause:function(a){return(1==arguments.length?a:!this._paused)?(this.trigger("Pause"),this._paused=!0,setTimeout(function(){p.timer.stop()},0),p.keydown={}):(this.trigger("Unpause"),this._paused=!1,setTimeout(function(){p.timer.init()},0)),this},isPaused:function(){return this._paused},timer:function(){var b,c,d,e="fixed",f=5,g=40,h=0,i=0,j=0,k=50,l=1e3/k;return{init:function(){"undefined"==typeof d&&(d=+new Date-l);var e=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||null;e?(b=function(){p.timer.step(),c=e(b)})():b=setInterval(function(){p.timer.step()},1e3/k)},stop:function(){p.trigger("CraftyStopTimer"),"number"==typeof b&&clearInterval(b);var d=a.cancelRequestAnimationFrame||a.webkitCancelRequestAnimationFrame||a.mozCancelRequestAnimationFrame||a.oCancelRequestAnimationFrame||a.msCancelRequestAnimationFrame||null;d&&d(c),b=null},steptype:function(a,b){if("variable"===a||"semifixed"===a)a="variable",b&&(g=b);else{if("fixed"!==a)throw"Invalid step type specified";a=a,b&&(f=b)}},step:function(){var a,b,c,k=0;if(currentTime=+new Date,h>0&&p.trigger("MeasureWaitTime",currentTime-h),d+i>=currentTime)return void(h=currentTime);var m=currentTime-(d+i);m>20*l&&(i+=m-l,m=l),"fixed"===e?(k=Math.ceil(m/l),k=Math.min(k,f),b=l):"variable"===e?(k=1,b=m,b=Math.min(b,g)):"semifixed"===e&&(k=Math.ceil(m/g),b=m/k);for(var n=0;n<k;n++)c=currentTime,p.trigger("EnterFrame",{frame:j++,dt:b,gameTime:d}),d+=b,currentTime=+new Date,p.trigger("MeasureFrameTime",currentTime-c);k>0&&(a=currentTime,p.trigger("RenderScene"),p.trigger("PostRender"),currentTime=+new Date,p.trigger("MeasureRenderTime",currentTime-a)),h=currentTime},FPS:function(a){return"undefined"==typeof a?k:(k=a,void(l=1e3/k))},simulateFrames:function(a,b){for("undefined"==typeof b&&(b=l);a-- >0;)p.trigger("EnterFrame",{frame:j++,dt:b});p.trigger("RenderScene")}}}(),e:function(){var a,b=d();return i[b]=null,i[b]=a=p(b),arguments.length>0&&a.addComponent.apply(a,arguments),a.setName("Entity #"+b),a.addComponent("obj"),p.trigger("NewEntity",{id:b}),a},c:function(a,b){h[a]=b},trigger:function(a,b){var c,d,e,f,g=j[a];for(c in g)if(g.hasOwnProperty(c)&&(e=g[c],e&&0!=e.length))for(f=i[c]?p(+c):p,d=0;d<e.length;d++)"undefined"==typeof e[d]?(e.splice(d,1),d--):e[d].call(f,b)},bind:function(a,b){j[a]||(j[a]={});var c=j[a];return c.global||(c.global=[]),c.global.push(b)-1},uniqueBind:function(a,b){this.unbind(a,b),this.bind(a,b)},one:function(a,b){var c=this,d=function(e){b.call(c,e),c.unbind(a,d)};return c.bind(a,d)},unbind:function(a,b){var d,e,f,g,h=j[a];if(h===c||h.global===c||0===h.global.length)return!1;if(1===arguments.length)return delete h.global,!0;for(f=h.global,g=!1,d=0,e=f.length;d<e;d++)f[d]===b&&(g=!0,delete f[d]);return g},frame:function(){return g},components:function(){return h},isComp:function(a){return a in h},debug:function(){return i},settings:function(){var a={},b={};return{register:function(a,c){b[a]=c},modify:function(c,d){b[c]&&(b[c].call(a[c],d),a[c]=d)},get:function(b){return a[b]}}}(),clone:e}),p.bind("Load",function(){!p.support.setter&&p.support.defineProperty&&(l=[],p.bind("EnterFrame",function(){for(var a,b=0,c=l.length;b<c;++b)a=l[b],a.obj[a.prop]!==a.obj["_"+a.prop]&&a.fn.call(a.obj,a.obj[a.prop])}))}),b(p,a,a.document),"function"==typeof define?define("crafty",[],function(){return p}):"object"==typeof exports?module.exports=p:a.Crafty=p}(window,function(Crafty,window,document){function tweenEnterFrame(a){if(!(this._numProps<=0)){var b,c;for(c in this._step)b=this._step[c],this[c]+=b.val,0==--b.rem&&(this[c]=b.prop,this.trigger("TweenEnd",c),this._step[c].rem<=0&&delete this._step[c],this._numProps--);if(this.has("Mouse")){var d=Crafty.over,e=Crafty.mousePos;d&&d[0]==this[0]&&!this.isAt(e.x,e.y)?(this.trigger("MouseOut",Crafty.lastEvent),Crafty.over=null):d&&d[0]==this[0]||!this.isAt(e.x,e.y)||(Crafty.over=this,this.trigger("MouseOver",Crafty.lastEvent))}}}!function(a){function b(a,b,c){this.keys=a,this.map=c,this.obj=b}var c,d=function(a){c=a||64,this.map={}},e=" ",f={};d.prototype={insert:function(a){var c,e,f=d.key(a),g=new b(f,a,this),h=0;for(h=f.x1;h<=f.x2;h++)for(c=f.y1;c<=f.y2;c++)e=h<<16^c,this.map[e]||(this.map[e]=[]),this.map[e].push(a);return g},search:function(a,b){var c,e,g,h=d.key(a,f),i=[];for(void 0===b&&(b=!0),c=h.x1;c<=h.x2;c++)for(e=h.y1;e<=h.y2;e++)if(cell=this.map[c<<16^e],cell)for(g=0;g<cell.length;g++)i.push(cell[g]);if(b){var j,k,m=[],n={};for(c=0,l=i.length;c<l;c++)j=i[c],j&&(k=j[0],j=j._mbr||j,!n[k]&&j._x<a._x+a._w&&j._x+j._w>a._x&&j._y<a._y+a._h&&j._h+j._y>a._y&&(n[k]=i[c]));for(j in n)m.push(n[j]);return m}return i},remove:function(a,b){var c,e,g=0;for(1==arguments.length&&(b=a,a=d.key(b,f)),g=a.x1;g<=a.x2;g++)for(c=a.y1;c<=a.y2;c++)if(e=g<<16^c,this.map[e]){var h,i=this.map[e],j=i.length;for(h=0;h<j;h++)i[h]&&i[h][0]===b[0]&&i.splice(h,1)}},refresh:function(a){var b,c,e,f,g,h=a.keys,i=a.obj;for(c=h.x1;c<=h.x2;c++)for(e=h.y1;e<=h.y2;e++)if(b=this.map[c<<16^e])for(g=b.length,f=0;f<g;f++)b[f]&&b[f][0]===i[0]&&b.splice(f,1);for(d.key(i,h),c=h.x1;c<=h.x2;c++)for(e=h.y1;e<=h.y2;e++)b=this.map[c<<16^e],b||(b=this.map[c<<16^e]=[]),b.push(i);return a},boundaries:function(){var a,b,c={max:{x:-(1/0),y:-(1/0)},min:{x:1/0,y:1/0}},d={max:{x:-(1/0),y:-(1/0)},min:{x:1/0,y:1/0}};for(var e in this.map)if(this.map[e].length){var f=e>>16,g=e<<16>>16;if(g<0&&(f^=-1),f>=c.max.x){c.max.x=f;for(a in this.map[e])b=this.map[e][a],"object"==typeof b&&"requires"in b&&(d.max.x=Math.max(d.max.x,b.x+b.w))}if(f<=c.min.x){c.min.x=f;for(a in this.map[e])b=this.map[e][a],"object"==typeof b&&"requires"in b&&(d.min.x=Math.min(d.min.x,b.x))}if(g>=c.max.y){c.max.y=g;for(a in this.map[e])b=this.map[e][a],"object"==typeof b&&"requires"in b&&(d.max.y=Math.max(d.max.y,b.y+b.h))}if(g<=c.min.y){c.min.y=g;for(a in this.map[e])b=this.map[e][a],"object"==typeof b&&"requires"in b&&(d.min.y=Math.min(d.min.y,b.y))}}return d}},d.key=function(a,b){return a._mbr&&(a=a._mbr),b||(b={}),b.x1=Math.floor(a._x/c),b.y1=Math.floor(a._y/c),b.x2=Math.floor((a._w+a._x)/c),b.y2=Math.floor((a._h+a._y)/c),b},d.hash=function(a){return a.x1+e+a.y1+e+a.x2+e+a.y2},b.prototype={update:function(a){d.hash(d.key(a,f))!=d.hash(this.keys)&&this.map.refresh(this)}},a.HashMap=d}(Crafty),Crafty._rectPool=function(){var a=[],b=0;return{get:function(c,d,e,f){a.length<=b&&a.push({});var g=a[b++];return g._x=c,g._y=d,g._w=e,g._h=f,g},copy:function(c){a.length<=b&&a.push({});var d=a[b++];return d._x=c._x,d._y=c._y,d._w=c._w,d._h=c._h,d},recycle:function(a){b--}}}(),Crafty.map=new Crafty.HashMap;var M=Math,Mc=M.cos,Ms=M.sin,PI=M.PI,DEG_TO_RAD=PI/180;Crafty.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_rotation:0,_alpha:1,_visible:!0,_globalZ:null,_origin:null,_mbr:null,_entry:null,_children:null,_parent:null,_changed:!1,_defineGetterSetter_setter:function(){this.__defineSetter__("x",function(a){this._attr("_x",a)}),this.__defineSetter__("y",function(a){this._attr("_y",a)}),this.__defineSetter__("w",function(a){this._attr("_w",a)}),this.__defineSetter__("h",function(a){this._attr("_h",a)}),this.__defineSetter__("z",function(a){this._attr("_z",a)}),this.__defineSetter__("rotation",function(a){this._attr("_rotation",a)}),this.__defineSetter__("alpha",function(a){this._attr("_alpha",a)}),this.__defineSetter__("visible",function(a){this._attr("_visible",a)}),this.__defineGetter__("x",function(){return this._x}),this.__defineGetter__("y",function(){return this._y}),this.__defineGetter__("w",function(){return this._w}),this.__defineGetter__("h",function(){return this._h}),this.__defineGetter__("z",function(){return this._z}),this.__defineGetter__("rotation",function(){return this._rotation}),this.__defineGetter__("alpha",function(){return this._alpha}),this.__defineGetter__("visible",function(){return this._visible}),this.__defineGetter__("parent",function(){return this._parent}),this.__defineGetter__("numChildren",function(){return this._children.length})},_defineGetterSetter_defineProperty:function(){Object.defineProperty(this,"x",{set:function(a){this._attr("_x",a)},get:function(){return this._x},configurable:!0}),Object.defineProperty(this,"y",{set:function(a){this._attr("_y",a)},get:function(){return this._y},configurable:!0}),Object.defineProperty(this,"w",{set:function(a){this._attr("_w",a)},get:function(){return this._w},configurable:!0}),Object.defineProperty(this,"h",{set:function(a){this._attr("_h",a)},get:function(){return this._h},configurable:!0}),Object.defineProperty(this,"z",{set:function(a){this._attr("_z",a)},get:function(){return this._z},configurable:!0}),Object.defineProperty(this,"rotation",{set:function(a){this._attr("_rotation",a)},get:function(){return this._rotation},configurable:!0}),Object.defineProperty(this,"alpha",{set:function(a){this._attr("_alpha",a)},get:function(){return this._alpha},configurable:!0}),Object.defineProperty(this,"visible",{set:function(a){this._attr("_visible",a)},get:function(){return this._visible},configurable:!0})},_defineGetterSetter_fallback:function(){this.x=this._x,this.y=this._y,this.w=this._w,this.h=this._h,this.z=this._z,this.rotation=this._rotation,this.alpha=this._alpha,this.visible=this._visible,this.bind("EnterFrame",function(){if(this.x!==this._x||this.y!==this._y||this.w!==this._w||this.h!==this._h||this.z!==this._z||this.rotation!==this._rotation||this.alpha!==this._alpha||this.visible!==this._visible){var a=Crafty._rectPool.copy(this);if(this.rotation!==this._rotation)this._rotate(this.rotation);else{var b=this._mbr,c=!1;b&&(this.x!==this._x?(b._x-=this.x-this._x,c=!0):this.y!==this._y?(b._y-=this.y-this._y,c=!0):this.w!==this._w?(b._w-=this.w-this._w,c=!0):this.h!==this._h?(b._h-=this.h-this._h,c=!0):this.z!==this._z&&(b._z-=this.z-this._z,c=!0)),c&&this.trigger("Move",a)}this._x=this.x,this._y=this.y,this._w=this.w,this._h=this.h,this._z=this.z,this._rotation=this.rotation,this._alpha=this.alpha,this._visible=this.visible,this.trigger("Change",a),this.trigger("Move",a),Crafty._rectPool.recycle(a)}})},init:function(){this._globalZ=this[0],this._origin={x:0,y:0},this._children=[],Crafty.support.setter?this._defineGetterSetter_setter():Crafty.support.defineProperty?this._defineGetterSetter_defineProperty():this._defineGetterSetter_fallback(),this._entry=Crafty.map.insert(this),this.bind("Move",function(a){var b=this._mbr||this;this._entry.update(b),this._children.length>0&&this._cascade(a)}),this.bind("Rotate",function(a){var b=this._mbr||this;this._entry.update(b),this._children.length>0&&this._cascade(a)}),this.bind("Remove",function(){if(this._children){for(var a=0;a<this._children.length;a++)delete this._children[a]._parent,this._children[a].destroy&&this._children[a].destroy();this._children=[]}this._parent&&this._parent.detach(this),Crafty.map.remove(this),this.detach()})},_calculateMBR:function(a,b,c){if(0==c)return void(this._mbr=null);var d=Math.cos(c),e=Math.sin(c),f=a+(this._x-a)*d+(this._y-b)*e,g=b-(this._x-a)*e+(this._y-b)*d,h=a+(this._x+this._w-a)*d+(this._y-b)*e,i=b-(this._x+this._w-a)*e+(this._y-b)*d,j=a+(this._x+this._w-a)*d+(this._y+this._h-b)*e,k=b-(this._x+this._w-a)*e+(this._y+this._h-b)*d,l=a+(this._x-a)*d+(this._y+this._h-b)*e,m=b-(this._x-a)*e+(this._y+this._h-b)*d,n=Math.round(Math.min(f,h,j,l)),o=Math.round(Math.min(g,i,k,m)),p=Math.round(Math.max(f,h,j,l)),q=Math.round(Math.max(g,i,k,m));this._mbr?(this._mbr._x=n,this._mbr._y=o,this._mbr._w=p-n,this._mbr._h=q-o):this._mbr={_x:n,_y:o,_w:p-n,_h:q-o}},_rotate:function(a){var b=-1*(a%360),c=this._rotation-a;if(0!=c){var d=b*DEG_TO_RAD,e={x:this._origin.x+this._x,y:this._origin.y+this._y};this._calculateMBR(e.x,e.y,d);var f=c*DEG_TO_RAD,g=Math.cos(d),h=Math.sin(d);this.trigger("Rotate",{cos:Math.cos(f),sin:Math.sin(f),deg:c,rad:f,o:e,matrix:{M11:g,M12:h,M21:-h,M22:g}})}},area:function(){return this._w*this._h},intersect:function(a,b,c,d){var e,f=this._mbr||this;return e="object"==typeof a?a:{x:a,y:b,w:c,h:d},f._x<e.x+e.w&&f._x+f._w>e.x&&f._y<e.y+e.h&&f._h+f._y>e.y},within:function(a,b,c,d){var e,f=this._mbr||this;return e="object"==typeof a?a:{_x:a,_y:b,_w:c,_h:d},e._x<=f._x&&e._x+e._w>=f._x+f._w&&e._y<=f._y&&e._y+e._h>=f._y+f._h},contains:function(a,b,c,d){var e,f=this._mbr||this;return e="object"==typeof a?a:{_x:a,_y:b,_w:c,_h:d},e._x>=f._x&&e._x+e._w<=f._x+f._w&&e._y>=f._y&&e._y+e._h<=f._y+f._h},pos:function(){return{_x:this._x,_y:this._y,_w:this._w,_h:this._h}},mbr:function(){return this._mbr?{_x:this._mbr._x,_y:this._mbr._y,_w:this._mbr._w,_h:this._mbr._h}:this.pos()},isAt:function(a,b){if(this.mapArea)return this.mapArea.containsPoint(a,b);if(this.map)return this.map.containsPoint(a,b);var c=this._mbr||this;return c._x<=a&&c._x+c._w>=a&&c._y<=b&&c._y+c._h>=b},move:function(a,b){return"n"===a.charAt(0)&&(this.y-=b),"s"===a.charAt(0)&&(this.y+=b),"e"!==a&&"e"!==a.charAt(1)||(this.x+=b),"w"!==a&&"w"!==a.charAt(1)||(this.x-=b),this},shift:function(a,b,c,d){return a&&(this.x+=a),b&&(this.y+=b),c&&(this.w+=c),d&&(this.h+=d),this},_cascade:function(a){if(a){var b,c=0,d=this._children,e=d.length;if(a.cos)for(;c<e;++c)b=d[c],"rotate"in b&&b.rotate(a);else for(var f=this._x-a._x,g=this._y-a._y,h=this._w-a._w,i=this._h-a._h;c<e;++c)b=d[c],b.shift(f,g,h,i)}},attach:function(){for(var a,b=0,c=arguments,d=arguments.length;b<d;++b)a=c[b],a._parent&&a._parent.detach(a),a._parent=this,this._children.push(a);return this},detach:function(a){if(!a){for(var b=0;b<this._children.length;b++)this._children[b]._parent=null;return this._children=[],this}for(var b=0;b<this._children.length;b++)this._children[b]==a&&this._children.splice(b,1);return a._parent=null,this},origin:function(a,b){if("string"==typeof a)if("centre"===a||"center"===a||a.indexOf(" ")===-1)a=this._w/2,b=this._h/2;else{var c=a.split(" ");"top"===c[0]?b=0:"bottom"===c[0]?b=this._h:"middle"!==c[0]&&"center"!==c[1]&&"centre"!==c[1]||(b=this._h/2),"center"===c[1]||"centre"===c[1]||"middle"===c[1]?a=this._w/2:"left"===c[1]?a=0:"right"===c[1]&&(a=this._w)}return this._origin.x=a,this._origin.y=b,this},flip:function(a){return a=a||"X",this["_flip"+a]||(this["_flip"+a]=!0,this.trigger("Change")),this},unflip:function(a){return a=a||"X",this["_flip"+a]&&(this["_flip"+a]=!1,this.trigger("Change")),this},rotate:function(a){this._origin.x=a.o.x-this._x,this._origin.y=a.o.y-this._y,this._attr("_rotation",this._rotation-a.deg)},_attr:function(a,b){if(this[a]!==b){var c=Crafty._rectPool.copy(this);if("_rotation"===a)this._rotate(b);else if("_z"===a)this._globalZ=parseInt(b+Crafty.zeroFill(this[0],5),10),this.trigger("reorder");else if("_x"===a||"_y"===a){var d=this._mbr;d&&(d[a]-=this[a]-b),this[a]=b,this.trigger("Move",c)}else if("_h"===a||"_w"===a){var d=this._mbr,e=this[a];this[a]=b,d&&this._calculateMBR(this._origin.x+this.x,this._origin.y+this.y,-this.rotation*DEG_TO_RAD),"_w"===a?this.trigger("Resize",{axis:"w",amount:b-e}):"_h"===a&&this.trigger("Resize",{axis:"h",amount:b-e}),this.trigger("Move",c)}this[a]=b,this.trigger("Change",c),Crafty._rectPool.recycle(c)}}}),Crafty.c("Physics",{_gravity:.4,_friction:.2,_bounce:.5,gravity:function(a){this._gravity=a}}),Crafty.c("Gravity",{_gravityConst:.2,_gy:0,_falling:!0,_anti:null,init:function(){this.requires("2D")},gravity:function(a){return a&&(this._anti=a),this.bind("EnterFrame",this._enterFrame),this},gravityConst:function(a){return this._gravityConst=a,this},_enterFrame:function(){this._falling?(this._gy+=this._gravityConst,this.y+=this._gy):this._gy=0;var a,b,c,d=!1,e=this.pos(),f=0;for(e._y++,e.x=e._x,e.y=e._y,e.w=e._w,e.h=e._h,b=Crafty.map.search(e),c=b.length;f<c;++f)if(a=b[f],a!==this&&a.has(this._anti)&&a.intersect(e)){d=a;break}d?this._falling&&this.stopFalling(d):this._falling=!0},stopFalling:function(a){a&&(this.y=a._y-this._h),this._falling=!1,this._up&&(this._up=!1),this.trigger("hit")},antigravity:function(){this.unbind("EnterFrame",this._enterFrame)}}),Crafty.polygon=function(a){arguments.length>1&&(a=Array.prototype.slice.call(arguments,0)),this.points=a},Crafty.polygon.prototype={containsPoint:function(a,b){var c,d,e=this.points,f=!1;for(c=0,d=e.length-1;c<e.length;d=c++)e[c][1]>b!=e[d][1]>b&&a<(e[d][0]-e[c][0])*(b-e[c][1])/(e[d][1]-e[c][1])+e[c][0]&&(f=!f);return f},shift:function(a,b){for(var c,d=0,e=this.points.length;d<e;d++)c=this.points[d],c[0]+=a,c[1]+=b},rotate:function(a){for(var b,c,d,e=0,f=this.points.length;e<f;e++)b=this.points[e],c=a.o.x+(b[0]-a.o.x)*a.cos+(b[1]-a.o.y)*a.sin,d=a.o.y-(b[0]-a.o.x)*a.sin+(b[1]-a.o.y)*a.cos,b[0]=c,b[1]=d}},Crafty.circle=function(a,b,c){this.x=a,this.y=b,this.radius=c,this.points=[];for(var d,e=0;e<8;e++)d=e*Math.PI/4,this.points[e]=[this.x+Math.sin(d)*c,this.y+Math.cos(d)*c]},Crafty.circle.prototype={containsPoint:function(a,b){var c=this.radius,d=(Math.sqrt,this.x-a),e=this.y-b;return d*d+e*e<c*c},shift:function(a,b){this.x+=a,this.y+=b;for(var c,d=0,e=this.points.length;d<e;d++)c=this.points[d],c[0]+=a,c[1]+=b},rotate:function(){}},Crafty.matrix=function(a){this.mtx=a,this.width=a[0].length,this.height=a.length},Crafty.matrix.prototype={x:function(a){if(this.width==a.height){for(var b=[],c=0;c<this.height;c++){b[c]=[];for(var d=0;d<a.width;d++){for(var e=0,f=0;f<this.width;f++)e+=this.mtx[c][f]*a.mtx[f][d];b[c][d]=e}}return new Crafty.matrix(b)}},e:function(a,b){return a<1||a>this.mtx.length||b<1||b>this.mtx[0].length?null:this.mtx[a-1][b-1]}},Crafty.c("Collision",{init:function(){this.requires("2D");this._mbr||this;this.collision()},collision:function(a){if(this.unbind("Resize",this._resizeMap),a||(a=new Crafty.polygon([0,0],[this._w,0],[this._w,this._h],[0,this._h]),this.bind("Resize",this._resizeMap)),this.rotation&&a.rotate({cos:Math.cos(-this.rotation*DEG_TO_RAD),sin:Math.sin(-this.rotation*DEG_TO_RAD),o:{x:this._origin.x,y:this._origin.y}}),arguments.length>1){var b=Array.prototype.slice.call(arguments,0);a=new Crafty.polygon(b)}return this.map=a,this.attach(this.map),this.map.shift(this._x,this._y),this},_resizeMap:function(a){var b,c,d=this.rotation*DEG_TO_RAD,e=this.map.points;"w"===a.axis?(d?(b=a.amount*Math.cos(d),c=a.amount*Math.sin(d)):(b=a.amount,c=0),e[1][0]+=b,e[1][1]+=c):(d?(c=a.amount*Math.cos(d),b=-a.amount*Math.sin(d)):(b=0,c=a.amount),e[3][0]+=b,e[3][1]+=c),e[2][0]+=b,e[2][1]+=c},hit:function(a){var b,c,d,e,f=this._mbr||this,g=Crafty.map.search(f,!1),h=0,i=g.length,j={},k="map"in this&&"containsPoint"in this.map,l=[];if(!i)return!1;for(;h<i;++h)c=g[h],d=c._mbr||c,c&&(b=c[0],!j[b]&&this[0]!==b&&c.__c[a]&&d._x<f._x+f._w&&d._x+d._w>f._x&&d._y<f._y+f._h&&d._h+d._y>f._y&&(j[b]=c));for(e in j)if(c=j[e],k&&"map"in c){var m=this._SAT(this.map,c.map);m.obj=c,m.type="SAT",m&&l.push(m)}else l.push({obj:c,type:"MBR"});return!!l.length&&l},onHit:function(a,b,c){var d=!1;return this.bind("EnterFrame",function(){var e=this.hit(a);e?(d=!0,b.call(this,e)):d&&("function"==typeof c&&c.call(this),d=!1)}),this},_SAT:function(a,b){for(var c,d,e,f,g,h,i,j,k,l,m=a.points,n=b.points,o=0,p=m.length,q=n.length,r={x:0,y:0},s=null,t=null,u=null;o<p;o++){for(k=m[o==p-1?0:o+1],l=m[o],r.x=-(k[1]-l[1]),r.y=k[0]-l[0],d=Math.sqrt(r.x*r.x+r.y*r.y),r.x/=d,r.y/=d,e=f=-1,g=h=-1,c=0;c<p;++c)j=m[c][0]*r.x+m[c][1]*r.y,(j>g||g===-1)&&(g=j),(j<e||e===-1)&&(e=j);for(c=0;c<q;++c)j=n[c][0]*r.x+n[c][1]*r.y,(j>h||h===-1)&&(h=j),(j<f||f===-1)&&(f=j);if(e<f?(i=f-g,r.x=-r.x,r.y=-r.y):i=e-h,i>=0)return!1;(null===s||i>s)&&(s=i,u={x:r.x,y:r.y})}for(o=0;o<q;o++){for(k=n[o==q-1?0:o+1],l=n[o],r.x=-(k[1]-l[1]),r.y=k[0]-l[0],d=Math.sqrt(r.x*r.x+r.y*r.y),r.x/=d,r.y/=d,e=f=-1,g=h=-1,c=0;c<p;++c)j=m[c][0]*r.x+m[c][1]*r.y,(j>g||g===-1)&&(g=j),(j<e||e===-1)&&(e=j);for(c=0;c<q;++c)j=n[c][0]*r.x+n[c][1]*r.y,(j>h||h===-1)&&(h=j),(j<f||f===-1)&&(f=j);if(e<f?(i=f-g,r.x=-r.x,r.y=-r.y):i=e-h,i>=0)return!1;(null===s||i>s)&&(s=i),(i>t||null===t)&&(t=i,u={x:r.x,y:r.y})}return{overlap:t,normal:u}}}),Crafty.c("DOM",{_element:null,_cssStyles:null,init:function(){function a(){var a=0,b=this.__c,c="";for(a in b)c+=" "+a;c=c.substr(1),this._element.className=c}this._cssStyles={visibility:"",left:"",top:"",width:"",height:"",zIndex:"",opacity:"",transformOrigin:"",transform:""},this._element=document.createElement("div"),Crafty.stage.inner.appendChild(this._element),this._element.style.position="absolute",this._element.id="ent"+this[0],this.bind("Change",function(){this._changed||(this._changed=!0,Crafty.DrawManager.addDom(this))}),this.bind("NewComponent",a).bind("RemoveComponent",a),"ms"===Crafty.support.prefix&&Crafty.support.version<9&&(this._filters={},this.bind("Rotate",function(a){var b=a.matrix,c=(this._element.style,b.M11.toFixed(8)),d=b.M12.toFixed(8),e=b.M21.toFixed(8),f=b.M22.toFixed(8);this._filters.rotation="progid:DXImageTransform.Microsoft.Matrix(M11="+c+", M12="+d+", M21="+e+", M22="+f+",sizingMethod='auto expand')"})),this.bind("Remove",this.undraw),this.bind("RemoveComponent",function(a){"DOM"===a&&this.undraw()})},getDomId:function(){return this._element.id},DOM:function(a){return a&&a.nodeType&&(this.undraw(),this._element=a,this._element.style.position="absolute"),this},draw:function(){var a=this._element.style,b=this.__coord||[0,0,0,0],c={x:b[0],y:b[1],w:b[2],h:b[3]},d=Crafty.support.prefix,e=[];if(this._cssStyles.visibility!==this._visible&&(this._cssStyles.visibility=this._visible,this._visible?a.visibility="visible":a.visibility="hidden"),Crafty.support.css3dtransform?e.push("translate3d("+~~this._x+"px,"+~~this._y+"px,0)"):(this._cssStyles.left!==this._x&&(this._cssStyles.left=this._x,a.left=~~this._x+"px"),this._cssStyles.top!==this._y&&(this._cssStyles.top=this._y,a.top=~~this._y+"px")),this._cssStyles.width!==this._w&&(this._cssStyles.width=this._w,a.width=~~this._w+"px"),this._cssStyles.height!==this._h&&(this._cssStyles.height=this._h,a.height=~~this._h+"px"),this._cssStyles.zIndex!==this._z&&(this._cssStyles.zIndex=this._z,a.zIndex=this._z),this._cssStyles.opacity!==this._alpha&&(this._cssStyles.opacity=this._alpha,a.opacity=this._alpha,a[d+"Opacity"]=this._alpha),"ms"===d&&Crafty.support.version<9&&(8===Crafty.support.version?this._filters.alpha="progid:DXImageTransform.Microsoft.Alpha(Opacity="+100*this._alpha+")":this._filters.alpha="alpha(opacity="+100*this._alpha+")"),this._mbr){var f=this._origin.x+"px "+this._origin.y+"px";a.transformOrigin=f,a[d+"TransformOrigin"]=f,Crafty.support.css3dtransform?e.push("rotateZ("+this._rotation+"deg)"):e.push("rotate("+this._rotation+"deg)")}return this._flipX&&(e.push("scaleX(-1)"),"ms"===d&&Crafty.support.version<9&&(this._filters.flipX="fliph")),this._flipY&&(e.push("scaleY(-1)"),"ms"===d&&Crafty.support.version<9&&(this._filters.flipY="flipv")),"ms"===d&&Crafty.support.version<9&&this.applyFilters(),this._cssStyles.transform!=e.join(" ")&&(this._cssStyles.transform=e.join(" "),a.transform=this._cssStyles.transform,a[d+"Transform"]=this._cssStyles.transform),this.trigger("Draw",{style:a,type:"DOM",co:c}),this},applyFilters:function(){this._element.style.filter="";var a="";for(var b in this._filters)this._filters.hasOwnProperty(b)&&(a+=this._filters[b]+" ");this._element.style.filter=a},undraw:function(){return this._element&&Crafty.stage.inner.removeChild(this._element),this},css:function(a,b){var c,d,e=this._element,f=e.style;if("object"==typeof a)for(c in a)a.hasOwnProperty(c)&&(d=a[c],"number"==typeof d&&(d+="px"),f[Crafty.DOM.camelize(c)]=d);else{if(!b)return Crafty.DOM.getStyle(e,a);"number"==typeof b&&(b+="px"),f[Crafty.DOM.camelize(a)]=b}return this.trigger("Change"),this}});try{document.execCommand("BackgroundImageCache",!1,!0)}catch(a){}Crafty.extend({DOM:{window:{init:function(){this.width=window.innerWidth||window.document.documentElement.clientWidth||window.document.body.clientWidth,this.height=window.innerHeight||window.document.documentElement.clientHeight||window.document.body.clientHeight,Crafty.unbind("RenderScene",Crafty.DrawManager.renderDOM),Crafty.bind("RenderScene",Crafty.DrawManager.renderDOM)},width:0,height:0},inner:function(a){var b=a.getBoundingClientRect(),c=b.left+(window.pageXOffset?window.pageXOffset:document.body.scrollLeft),d=b.top+(window.pageYOffset?window.pageYOffset:document.body.scrollTop),e=parseInt(this.getStyle(a,"border-left-width")||0,10)||parseInt(this.getStyle(a,"borderLeftWidth")||0,10)||0,f=parseInt(this.getStyle(a,"border-top-width")||0,10)||parseInt(this.getStyle(a,"borderTopWidth")||0,10)||0;return c+=e,d+=f,{x:c,y:d}},getStyle:function(a,b){var c;return a.currentStyle?c=a.currentStyle[this.camelize(b)]:window.getComputedStyle&&(c=document.defaultView.getComputedStyle(a,null).getPropertyValue(this.csselize(b))),c},camelize:function(a){return a.replace(/-+(.)?/g,function(a,b){return b?b.toUpperCase():""})},csselize:function(a){return a.replace(/[A-Z]/g,function(a){return a?"-"+a.toLowerCase():""})},translate:function(a,b){return{x:(a-Crafty.stage.x+document.body.scrollLeft+document.documentElement.scrollLeft-Crafty.viewport._x)/Crafty.viewport._scale,y:(b-Crafty.stage.y+document.body.scrollTop+document.documentElement.scrollTop-Crafty.viewport._y)/Crafty.viewport._scale}}}}),Crafty.c("HTML",{inner:"",init:function(){this.requires("2D, DOM")},replace:function(a){return this.inner=a,this._element.innerHTML=a,this},append:function(a){return this.inner+=a,this._element.innerHTML+=a,this},prepend:function(a){return this.inner=a+this.inner,this._element.innerHTML=a+this.inner,this}}),Crafty.storage=function(){function process(a){if(a.c){var b=Crafty.e(a.c).attr(a.attr).trigger("LoadData",a,process);return b}if("object"==typeof a)for(var c in a)a[c]=process(a[c]);return a}function unserialize(str){if("string"!=typeof str)return null;var data=JSON?JSON.parse(str):eval("("+str+")");return process(data)}function prep(a){if(a.__c){var b={c:[],attr:{}};a.trigger("SaveData",b,prep);for(var c in a.__c)b.c.push(c);b.c=b.c.join(", "),a=b}else if("object"==typeof a)for(var d in a)a[d]=prep(a[d]);return a}function serialize(a){if(JSON){var b=prep(a);return JSON.stringify(b)}return alert("Crafty does not support saving on your browser. Please upgrade to a newer browser."),!1}function external(a){url=a}function openExternal(){if("undefined"!=typeof url){var xml=new XMLHttpRequest;xhr.open("POST",url),xhr.onreadystatechange=function(evt){if(4==xhr.readyState&&200==xhr.status){var data=eval("("+xhr.responseText+")");for(var i in data)Crafty.storage.check(data[i].key,data[i].timestamp)&&loadExternal(data[i].key)}},xhr.send("mode=timestamps&game="+gameName)}}function saveExternal(a,b,c){if("undefined"!=typeof url){var d=new XMLHttpRequest;d.open("POST",url),d.send("mode=save&key="+a+"&data="+encodeURIComponent(b)+"&ts="+c+"&game="+gameName)}}function loadExternal(key){if("undefined"!=typeof url){var xhr=new XMLHttpRequest;xhr.open("POST",url),xhr.onreadystatechange=function(evt){if(4==xhr.readyState&&200==xhr.status){var data=eval("("+xhr.responseText+")");Crafty.storage.save(key,"save",data)}},xhr.send("mode=load&key="+key+"&game="+gameName)}}function ts(){var a=new Date;return a.getTime()}var db=null,url,gameName,timestamps={},transactionType={READ:"readonly",READ_WRITE:"readwrite"};return"object"!=typeof indexedDB&&(window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,
"object"==typeof IDBTransaction&&(transactionType.READ=IDBTransaction.READ||IDBTransaction.readonly||transactionType.READ||"read",transactionType.READ_WRITE=IDBTransaction.READ_WRITE||IDBTransaction.readwrite||transactionType.READ_WRITE||"readwrite")),"object"==typeof indexedDB?{open:function(a){function b(){try{var a=db.transaction(["save"],"read"),b=a.objectStore("save"),c=b.getAll();c.onsuccess=function(a){for(var b=0,c=event.target.result,d=c.length;b<d;b++)timestamps[c[b].key]=c[b].timestamp}}catch(a){}}function c(){var a=db.setVersion("1.0");a.onsuccess=function(a){for(var b=0;b<d.length;b++){var c=d[b];if(!db.objectStoreNames.contains(c)){db.createObjectStore(c,{keyPath:"key"})}}}}gameName=a;var d=[];if(1==arguments.length?(d.push("save"),d.push("cache")):(d=arguments,d.shift(),d.push("save"),d.push("cache")),null==db){var e=indexedDB.open(gameName);e.onsuccess=function(a){db=a.target.result,b(),openExternal()},e.onupgradeneeded=function(a){c()}}else c(),b(),openExternal()},save:function(a,b,c,d){if(null==db)return void setTimeout(function(){Crafty.storage.save(a,b,c)},1);var e=serialize(c),f=ts();"save"==b&&saveExternal(a,e,f);try{var g=db.transaction([b],transactionType.READ_WRITE).objectStore(b).add({data:e,timestamp:f,key:a});"function"==typeof d&&(g.onsuccess=d)}catch(a){console.error(a)}},load:function(a,b,c){if(null==db)return void setTimeout(function(){Crafty.storage.load(a,b,c)},1);try{var d=db.transaction([b],transactionType.READ).objectStore(b).get(a);d.onsuccess=function(a){c(unserialize(a.target.result.data))}}catch(a){console.error(a)}},getAllKeys:function(a,b){null==db&&setTimeout(function(){Crafty.storage.getAllkeys(a,b)},1);try{var c=db.transaction([a],transactionType.READ).objectStore(a).openCursor(),d=[];c.onsuccess=function(a){var c=a.target.result;c?(d.push(c.key),c.continue()):b(d)}}catch(a){console.error(a)}},check:function(a,b){return timestamps[a]>b},external:external}:"function"==typeof openDatabase?{open:function(a){if(gameName=a,1==arguments.length)db={save:openDatabase(a+"_save","1.0","Saves games for "+a,5242880),cache:openDatabase(a+"_cache","1.0","Cache for "+a,5242880)};else{var b=arguments,c=0;for(b.shift();c<b.length;c++)"undefined"==typeof db[b[c]]&&(db[b[c]]=openDatabase(gameName+"_"+b[c],"1.0",type,5242880))}db.save.transaction(function(a){a.executeSql("SELECT key, timestamp FROM data",[],function(a,b){for(var c=0,d=b.rows,e=d.length;c<e;c++)timestamps[d.item(c).key]=d.item(c).timestamp})})},save:function(a,b,c){"undefined"==typeof db[b]&&""!=gameName&&this.open(gameName,b);var d=serialize(c),e=ts();"save"==b&&saveExternal(a,d,e),db[b].transaction(function(b){b.executeSql("CREATE TABLE IF NOT EXISTS data (key unique, text, timestamp)"),b.executeSql("SELECT * FROM data WHERE key = ?",[a],function(b,c){c.rows.length?b.executeSql("UPDATE data SET text = ?, timestamp = ? WHERE key = ?",[d,e,a]):b.executeSql("INSERT INTO data VALUES (?, ?, ?)",[a,d,e])})})},load:function(a,b,c){return null==db[b]?void setTimeout(function(){Crafty.storage.load(a,b,c)},1):void db[b].transaction(function(b){b.executeSql("SELECT text FROM data WHERE key = ?",[a],function(a,b){b.rows.length&&(res=unserialize(b.rows.item(0).text),c(res))})})},getAllKeys:function(a,b){return null==db[a]?void setTimeout(function(){Crafty.storage.getAllKeys(a,b)},1):void db[a].transaction(function(a){a.executeSql("SELECT key FROM data",[],function(a,c){b(c.rows)})})},check:function(a,b){return timestamps[a]>b},external:external}:"object"==typeof window.localStorage?{open:function(a){gameName=a},save:function(a,b,c){var d=gameName+"."+b+"."+a,e=serialize(c),f=ts();"save"==b&&saveExternal(a,e,f),window.localStorage[d]=e,"save"==b&&(window.localStorage[d+".ts"]=f)},load:function(a,b,c){var d=gameName+"."+b+"."+a,e=window.localStorage[d];c(unserialize(e))},getAllKeys:function(a,b){var c={},d=[],e=gameName+"."+a;for(var f in window.localStorage)if(f.indexOf(e)!=-1){var g=f.replace(e,"").replace(".ts","");c[g]=!0}for(f in c)d.push(f);b(d)},check:function(a,b){var c=window.localStorage[gameName+".save."+a+".ts"];return parseInt(b)>parseInt(c)},external:external}:{open:function(a){gameName=a},save:function(a,b,c){if("save"==b){var d=serialize(c),e=ts();"save"==b&&saveExternal(a,d,e),document.cookie=gameName+"_"+a+"="+d+"; "+gameName+"_"+a+"_ts="+e+"; expires=Thur, 31 Dec 2099 23:59:59 UTC; path=/"}},load:function(a,b,c){if("save"==b){var d=new RegExp(gameName+"_"+a+"=[^;]*"),e=d.exec(document.cookie),f=unserialize(e[0].replace(gameName+"_"+a+"=",""));c(f)}},getAllKeys:function(a,b){if("save"==a){for(var c=new RegExp(gameName+"_[^_=]","g"),d=c.exec(document.cookie),e=0,f=d.length,g={},h=[];e<f;e++){var i=d[e].replace(gameName+"_","");g[i]=!0}for(e in g)h.push(e);b(h)}},check:function(a,b){var c=gameName+"_"+a+"_ts",d=new RegExp(c+"=[^;]"),e=d.exec(document.cookie),f=e[0].replace(c+"=","");return parseInt(b)>parseInt(f)},external:external}}(),function(){var a=Crafty.support={},b=navigator.userAgent.toLowerCase(),c=/(webkit)[ \/]([\w.]+)/.exec(b)||/(o)pera(?:.*version)?[ \/]([\w.]+)/.exec(b)||/(ms)ie ([\w.]+)/.exec(b)||/(moz)illa(?:.*? rv:([\w.]+))?/.exec(b)||[],d=/iPad|iPod|iPhone|Android|webOS|IEMobile/i.exec(b);if(d&&(Crafty.mobile=d[0]),a.setter="__defineSetter__"in this&&"__defineGetter__"in this,a.defineProperty=function(){if(!1 in Object)return!1;try{Object.defineProperty({},"x",{})}catch(a){return!1}return!0}(),a.audio="Audio"in window,a.prefix=c[1]||c[0],"moz"===a.prefix&&(a.prefix="Moz"),"o"===a.prefix&&(a.prefix="O"),c[2]&&(a.versionName=c[2],a.version=+c[2].split(".")[0]),a.canvas="getContext"in document.createElement("canvas"),a.canvas){var e;try{e=document.createElement("canvas").getContext("experimental-webgl"),e.viewportWidth=a.canvas.width,e.viewportHeight=a.canvas.height}catch(a){}a.webgl=!!e}else a.webgl=!1;a.css3dtransform="undefined"!=typeof document.createElement("div").style.Perspective||"undefined"!=typeof document.createElement("div").style[a.prefix+"Perspective"],a.deviceorientation="undefined"!=typeof window.DeviceOrientationEvent||"undefined"!=typeof window.OrientationEvent,a.devicemotion="undefined"!=typeof window.DeviceMotionEvent}(),Crafty.extend({zeroFill:function(a,b){return b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a.toString()},sprite:function(a,b,c,d,e,f){var g,h,i,j,k,l,m;"string"==typeof a&&(f=e,e=d,d=b,c=a,a=1,b=1),"string"==typeof b&&(f=e,e=d,d=c,c=b,b=a),!f&&e&&(f=e),e=parseInt(e||0,10),f=parseInt(f||0,10),m=Crafty.asset(c),m||(m=new Image,m.src=c,Crafty.asset(c,m),m.onload=function(){for(g in d)Crafty(g).each(function(){this.ready=!0,this.trigger("Change")})});for(g in d)d.hasOwnProperty(g)&&(h=d[g],i=h[0]*(a+e),j=h[1]*(b+f),k=h[2]*a||a,l=h[3]*b||b,Crafty.c(g,{ready:!1,__coord:[i,j,k,l],init:function(){this.requires("Sprite"),this.__trim=[0,0,0,0],this.__image=c,this.__coord=[this.__coord[0],this.__coord[1],this.__coord[2],this.__coord[3]],this.__tile=a,this.__tileh=b,this.__padding=[e,f],this.img=m,this.img.complete&&this.img.width>0&&(this.ready=!0,this.trigger("Change")),this.w=this.__coord[2],this.h=this.__coord[3]}}));return this},_events:{},addEvent:function(a,b,c,d){3===arguments.length&&(d=c,c=b,b=window.document);var e=function(b){var b=b||window.event;"function"==typeof d&&d.call(a,b)},f=a[0]||"";this._events[f+b+c+d]||(this._events[f+b+c+d]=e,b.attachEvent?b.attachEvent("on"+c,e):b.addEventListener(c,e,!1))},removeEvent:function(a,b,c,d){3===arguments.length&&(d=c,c=b,b=window.document);var e=a[0]||"",f=this._events[e+b+c+d];f&&(b.detachEvent?b.detachEvent("on"+c,f):b.removeEventListener(c,f,!1),delete this._events[e+b+c+d])},background:function(a){Crafty.stage.elem.style.background=a},keys:{BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190,PULT_UP:29460,PULT_DOWN:29461,PULT_LEFT:4,PULT_RIGHT:5},mouseButtons:{LEFT:0,MIDDLE:1,RIGHT:2}}),Crafty.extend({viewport:{clampToEntities:!0,width:0,height:0,_x:0,_y:0,_scale:1,bounds:null,scroll:function(a,b){b=Math.floor(b),this[a]=b,Crafty.trigger("ViewportScroll"),Crafty.trigger("InvalidateViewport")},rect:function(){return{_x:-this._x/this._scale,_y:-this._y/this._scale,_w:this.width/this._scale,_h:this.height/this._scale}},pan:function(){function a(a){var d=0;for(b in c){var e=c[b];e.remTime>0?(e.current+=e.diff,e.remTime--,Crafty.viewport[b]=Math.floor(e.current),d++):delete c[b]}d&&Crafty.viewport._clamp()}var b,c={},d=!1;return function(e,f,g){if(Crafty.viewport.follow(),"reset"!=e)0==g&&(g=1),c[e]={diff:-f/g,current:Crafty.viewport[e],remTime:g},d||(Crafty.bind("EnterFrame",a),d=!0);else for(b in c)c[b].remTime=0}}(),follow:function(){function a(){Crafty.viewport.scroll("_x",-(this.x+this.w/2-Crafty.viewport.width/2-c)),Crafty.viewport.scroll("_y",-(this.y+this.h/2-Crafty.viewport.height/2-d)),Crafty.viewport._clamp()}var b,c,d;return function(e,f,g){b&&b.unbind("Change",a),e&&e.has("2D")&&(Crafty.viewport.pan("reset"),b=e,c="undefined"!=typeof f?f:0,d="undefined"!=typeof g?g:0,e.bind("Change",a),a.call(e))}}(),centerOn:function(a,b){var c=a.x+Crafty.viewport.x,d=a.y+Crafty.viewport.y,e=a.w/2,f=a.h/2,g=Crafty.viewport.width/2,h=Crafty.viewport.height/2,i=c+e-g,j=d+f-h;Crafty.viewport.pan("reset"),Crafty.viewport.pan("x",i,b),Crafty.viewport.pan("y",j,b)},_zoom:1,zoom:function(){function a(){if(d>0){isFinite(Crafty.viewport._zoom)&&(b=Crafty.viewport._zoom);var a={width:g.width*b,height:g.height*b};b+=c,Crafty.viewport._zoom=b;var f={width:g.width*b,height:g.height*b},i={width:f.width-a.width,height:f.height-a.height};if(Crafty.stage.inner.style[e]="scale("+b+","+b+")",Crafty.canvas._canvas){var j=b/(b-c);Crafty.canvas.context.scale(j,j),Crafty.trigger("InvalidateViewport")}Crafty.viewport.x-=i.width*h.width,Crafty.viewport.y-=i.height*h.height,d--}}var b=1,c=0,d=0,e=Crafty.support.prefix+"Transform",f=!1,g={},h={};return function(e,i,j,k){var l=this.bounds||Crafty.map.boundaries(),m=e?b*e:1;e||(b=1,this._zoom=1),g.width=l.max.x-l.min.x,g.height=l.max.y-l.min.y,h.width=i/g.width,h.height=j/g.height,0==k&&(k=1),c=(m-b)/k,d=k,Crafty.viewport.pan("reset"),f||(Crafty.bind("EnterFrame",a),f=!0)}}(),scale:function(){return function(a){var b=(this.bounds||Crafty.map.boundaries(),a?a:1);this._zoom=b,this._scale=b,Crafty.trigger("InvalidateViewport"),Crafty.trigger("ViewportScale")}}(),mouselook:function(){var a=!1,b=!1,c={};return old={},function(d,e){if("boolean"==typeof d)return a=d,void(a?Crafty.mouseObjs++:Crafty.mouseObjs=Math.max(0,Crafty.mouseObjs-1));if(a)switch(d){case"move":case"drag":if(!b)return;diff={x:e.clientX-c.x,y:e.clientY-c.y},Crafty.viewport.x+=diff.x,Crafty.viewport.y+=diff.y,Crafty.viewport._clamp();case"start":c.x=e.clientX,c.y=e.clientY,b=!0;break;case"stop":b=!1}}}(),_clamp:function(){if(this.clampToEntities){var a=this.bounds||Crafty.map.boundaries();a.max.x*=this._zoom,a.min.x*=this._zoom,a.max.y*=this._zoom,a.min.y*=this._zoom,a.max.x-a.min.x>Crafty.viewport.width?(a.max.x-=Crafty.viewport.width,Crafty.viewport.x<-a.max.x?Crafty.viewport.x=-a.max.x:Crafty.viewport.x>-a.min.x&&(Crafty.viewport.x=-a.min.x)):Crafty.viewport.x=-1*(a.min.x+(a.max.x-a.min.x)/2-Crafty.viewport.width/2),a.max.y-a.min.y>Crafty.viewport.height?(a.max.y-=Crafty.viewport.height,Crafty.viewport.y<-a.max.y?Crafty.viewport.y=-a.max.y:Crafty.viewport.y>-a.min.y&&(Crafty.viewport.y=-a.min.y)):Crafty.viewport.y=-1*(a.min.y+(a.max.y-a.min.y)/2-Crafty.viewport.height/2)}},init:function(a,b,c){Crafty.DOM.window.init(),this.width=!a||Crafty.mobile?Crafty.DOM.window.width:a,this.height=!b||Crafty.mobile?Crafty.DOM.window.height:b,"undefined"==typeof c&&(c="cr-stage");var d;if("string"==typeof c)d=document.getElementById(c);else{if(!("undefined"!=typeof HTMLElement?c instanceof HTMLElement:c instanceof Element))throw new TypeError("stage_elem must be a string or an HTMLElement");d=c}Crafty.stage={x:0,y:0,fullscreen:!1,elem:d?d:document.createElement("div"),inner:document.createElement("div")},(!a&&!b||Crafty.mobile)&&(document.body.style.overflow="hidden",Crafty.stage.fullscreen=!0),Crafty.addEvent(this,window,"resize",Crafty.viewport.reload),Crafty.addEvent(this,window,"blur",function(){Crafty.settings.get("autoPause")&&(Crafty._paused||Crafty.pause())}),Crafty.addEvent(this,window,"focus",function(){Crafty._paused&&Crafty.settings.get("autoPause")&&Crafty.pause()}),Crafty.settings.register("stageSelectable",function(a){Crafty.stage.elem.onselectstart=a?function(){return!0}:function(){return!1}}),Crafty.settings.modify("stageSelectable",!1),Crafty.settings.register("stageContextMenu",function(a){Crafty.stage.elem.oncontextmenu=a?function(){return!0}:function(){return!1}}),Crafty.settings.modify("stageContextMenu",!1),Crafty.settings.register("autoPause",function(){}),Crafty.settings.modify("autoPause",!1),d||(document.body.appendChild(Crafty.stage.elem),Crafty.stage.elem.id=c);var e,f=Crafty.stage.elem.style;if(Crafty.stage.elem.appendChild(Crafty.stage.inner),Crafty.stage.inner.style.position="absolute",Crafty.stage.inner.style.zIndex="1",Crafty.stage.inner.style.transformStyle="preserve-3d",f.width=this.width+"px",f.height=this.height+"px",f.overflow="hidden",Crafty.mobile){f.position="absolute",f.left="0px",f.top="0px",void 0!=typeof f.webkitTapHighlightColor&&(f.webkitTapHighlightColor="rgba(0,0,0,0)");var g=document.createElement("meta"),h=document.getElementsByTagName("HEAD")[0];g.setAttribute("name","viewport"),g.setAttribute("content","width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"),h.appendChild(g),g=document.createElement("meta"),g.setAttribute("name","apple-mobile-web-app-capable"),g.setAttribute("content","yes"),h.appendChild(g),setTimeout(function(){window.scrollTo(0,1)},0),Crafty.addEvent(this,window,"touchmove",function(a){a.preventDefault()}),Crafty.stage.x=0,Crafty.stage.y=0}else f.position="relative",e=Crafty.DOM.inner(Crafty.stage.elem),Crafty.stage.x=e.x,Crafty.stage.y=e.y;Crafty.support.setter?(this.__defineSetter__("x",function(a){this.scroll("_x",a)}),this.__defineSetter__("y",function(a){this.scroll("_y",a)}),this.__defineGetter__("x",function(){return this._x}),this.__defineGetter__("y",function(){return this._y})):Crafty.support.defineProperty?(Object.defineProperty(this,"x",{set:function(a){this.scroll("_x",a)},get:function(){return this._x}}),Object.defineProperty(this,"y",{set:function(a){this.scroll("_y",a)},get:function(){return this._y}})):(this.x=this._x,this.y=this._y,Crafty.e("ViewportSetter"))},reload:function(){Crafty.DOM.window.init();var a,b=Crafty.DOM.window.width,c=Crafty.DOM.window.height;Crafty.stage.fullscreen&&(this.width=b,this.height=c,Crafty.stage.elem.style.width=b+"px",Crafty.stage.elem.style.height=c+"px",Crafty.canvas._canvas&&(Crafty.canvas._canvas.width=b,Crafty.canvas._canvas.height=c,Crafty.trigger("InvalidateViewport"))),a=Crafty.DOM.inner(Crafty.stage.elem),Crafty.stage.x=a.x,Crafty.stage.y=a.y},reset:function(){Crafty.viewport.pan("reset"),Crafty.viewport.follow(),Crafty.viewport.mouselook("stop"),Crafty.viewport.scale()}}}),Crafty.c("ViewportSetter",{init:function(){this.bind("EnterFrame",function(){Crafty.viewport._x!==Crafty.viewport.x&&Crafty.viewport.scroll("_x",Crafty.viewport.x),Crafty.viewport._y!==Crafty.viewport.y&&Crafty.viewport.scroll("_y",Crafty.viewport.y)})}}),Crafty.extend({device:{_deviceOrientationCallback:!1,_deviceMotionCallback:!1,_normalizeDeviceOrientation:function(a){var b;window.DeviceOrientationEvent?b={tiltLR:a.gamma,tiltFB:a.beta,dir:a.alpha,motUD:null}:window.OrientationEvent&&(b={tiltLR:90*a.x,tiltFB:a.y*-90,dir:null,motUD:a.z}),Crafty.device._deviceOrientationCallback(b)},_normalizeDeviceMotion:function(a){var b=a.accelerationIncludingGravity,c=b.z>0?1:-1,d={acceleration:b,rawAcceleration:"["+Math.round(b.x)+", "+Math.round(b.y)+", "+Math.round(b.z)+"]",facingUp:c,tiltLR:Math.round(b.x/9.81*-90),tiltFB:Math.round((b.y+9.81)/9.81*90*c)};Crafty.device._deviceMotionCallback(d)},deviceOrientation:function(a){this._deviceOrientationCallback=a,Crafty.support.deviceorientation&&(window.DeviceOrientationEvent?Crafty.addEvent(this,window,"deviceorientation",this._normalizeDeviceOrientation):window.OrientationEvent&&Crafty.addEvent(this,window,"MozOrientation",this._normalizeDeviceOrientation))},deviceMotion:function(a){this._deviceMotionCallback=a,Crafty.support.devicemotion&&window.DeviceMotionEvent&&Crafty.addEvent(this,window,"devicemotion",this._normalizeDeviceMotion)}}}),Crafty.c("Sprite",{__image:"",__tile:0,__tileh:0,__padding:null,__trim:null,img:null,ready:!1,init:function(){this.__trim=[0,0,0,0];var a=function(a){var b=a.co,c=a.pos,d=a.ctx;if("canvas"===a.type)d.drawImage(this.img,b.x,b.y,b.w,b.h,c._x,c._y,c._w,c._h);else if("DOM"===a.type){var e=this._h/b.h,f=this._w/b.w;this._element.style.background="url('"+this.__image+"') no-repeat -"+b.x*f+"px -"+b.y*e+"px",1==e&&1==f||(this._element.style.backgroundSize=this.img.width*f+"px "+this.img.height*e+"px")}};this.bind("Draw",a).bind("RemoveComponent",function(b){"Sprite"===b&&this.unbind("Draw",a)})},sprite:function(a,b,c,d){return this.__coord=[a*this.__tile+this.__padding[0]+this.__trim[0],b*this.__tileh+this.__padding[1]+this.__trim[1],this.__trim[2]||c*this.__tile||this.__tile,this.__trim[3]||d*this.__tileh||this.__tileh],this.trigger("Change"),this},crop:function(a,b,c,d){var e=this._mbr||this.pos();return this.__trim=[],this.__trim[0]=a,this.__trim[1]=b,this.__trim[2]=c,this.__trim[3]=d,this.__coord[0]+=a,this.__coord[1]+=b,this.__coord[2]=c,this.__coord[3]=d,this._w=c,this._h=d,this.trigger("Change",e),this}}),Crafty.c("Canvas",{init:function(){Crafty.canvas.context||Crafty.canvas.init(),Crafty.DrawManager.total2D++,this.currentRect={},this._changed=!0,Crafty.DrawManager.addCanvas(this),this.bind("Change",function(a){this._changed===!1&&(this._changed=!0,Crafty.DrawManager.addCanvas(this))}),this.bind("Remove",function(){Crafty.DrawManager.total2D--,this._changed=!0,Crafty.DrawManager.addCanvas(this)})},drawVars:{type:"canvas",pos:{},ctx:null,coord:[0,0,0,0],co:{x:0,y:0,w:0,h:0}},draw:function(a,b,c,d,e){if(this.ready){4===arguments.length&&(e=d,d=c,c=b,b=a,a=Crafty.canvas.context);var f=this.drawVars.pos;f._x=this._x+(b||0),f._y=this._y+(c||0),f._w=d||this._w,f._h=e||this._h,context=a||Crafty.canvas.context,coord=this.__coord||[0,0,0,0];var g=this.drawVars.co;if(g.x=coord[0]+(b||0),g.y=coord[1]+(c||0),g.w=d||coord[2],g.h=e||coord[3],this._mbr&&(context.save(),context.translate(this._origin.x+this._x,this._origin.y+this._y),f._x=-this._origin.x,f._y=-this._origin.y,context.rotate(this._rotation%360*(Math.PI/180))),(this._flipX||this._flipY)&&(context.save(),context.scale(this._flipX?-1:1,this._flipY?-1:1),this._flipX&&(f._x=-(f._x+f._w)),this._flipY&&(f._y=-(f._y+f._h))),this._alpha<1){var h=context.globalAlpha;context.globalAlpha=this._alpha}return this.drawVars.ctx=context,this.trigger("Draw",this.drawVars),(this._mbr||this._flipX||this._flipY)&&context.restore(),h&&(context.globalAlpha=h),this}}}),Crafty.extend({canvas:{context:null,init:function(){if(!Crafty.support.canvas)return Crafty.trigger("NoCanvas"),void Crafty.stop();var a;a=document.createElement("canvas"),a.width=Crafty.viewport.width,a.height=Crafty.viewport.height,a.style.position="absolute",a.style.left="0px",a.style.top="0px",Crafty.stage.elem.appendChild(a),Crafty.canvas.context=a.getContext("2d"),Crafty.canvas._canvas=a;var b=Crafty.viewport._scale;1!=b&&Crafty.canvas.context.scale(b,b),Crafty.unbind("RenderScene",Crafty.DrawManager.renderCanvas),Crafty.bind("RenderScene",Crafty.DrawManager.renderCanvas)}}}),Crafty.extend({over:null,mouseObjs:0,mousePos:{},lastEvent:null,keydown:{},selected:!1,detectBlur:function(a){var b=a.clientX>Crafty.stage.x&&a.clientX<Crafty.stage.x+Crafty.viewport.width&&a.clientY>Crafty.stage.y&&a.clientY<Crafty.stage.y+Crafty.viewport.height;!Crafty.selected&&b&&Crafty.trigger("CraftyFocus"),Crafty.selected&&!b&&Crafty.trigger("CraftyBlur"),Crafty.selected=b},mouseDispatch:function(a){if(Crafty.mouseObjs){Crafty.lastEvent=a;var b,c,d,e,f,g=-1,h=0,i=Crafty.DOM.translate(a.clientX,a.clientY),j={},k=a.target?a.target:a.srcElement,l=a.type;if(null==a.which?a.mouseButton=a.button<2?Crafty.mouseButtons.LEFT:4==a.button?Crafty.mouseButtons.MIDDLE:Crafty.mouseButtons.RIGHT:a.mouseButton=a.which<2?Crafty.mouseButtons.LEFT:2==a.which?Crafty.mouseButtons.MIDDLE:Crafty.mouseButtons.RIGHT,a.realX=e=Crafty.mousePos.x=i.x,a.realY=f=Crafty.mousePos.y=i.y,"CANVAS"!=k.nodeName){for(;"string"!=typeof k.id&&k.id.indexOf("ent")==-1;)k=k.parentNode;ent=Crafty(parseInt(k.id.replace("ent",""))),ent.has("Mouse")&&ent.isAt(e,f)&&(b=ent)}if(!b)for(c=Crafty.map.search({_x:e,_y:f,_w:1,_h:1},!1),d=c.length;h<d;++h)if(c[h].__c.Mouse&&c[h]._visible){var m=c[h],n=!1;if(!j[m[0]]&&(j[m[0]]=!0,m.mapArea?m.mapArea.containsPoint(e,f)&&(n=!0):m.isAt(e,f)&&(n=!0),n&&(m._z>=g||g===-1))){if(m._z===g&&m[0]<b[0])continue;g=m._z,b=m}}b?"mousedown"===l?b.trigger("MouseDown",a):"mouseup"===l?b.trigger("MouseUp",a):"dblclick"==l?b.trigger("DoubleClick",a):"click"==l?b.trigger("Click",a):"mousemove"===l?(b.trigger("MouseMove",a),this.over!==b&&(this.over&&(this.over.trigger("MouseOut",a),this.over=null),this.over=b,b.trigger("MouseOver",a))):b.trigger(l,a):("mousemove"===l&&this.over&&(this.over.trigger("MouseOut",a),this.over=null),"mousedown"===l?Crafty.viewport.mouselook("start",a):"mousemove"===l?Crafty.viewport.mouselook("drag",a):"mouseup"==l&&Crafty.viewport.mouselook("stop")),"mousemove"===l&&(this.lastEvent=a)}},touchDispatch:function(a){var b,c=Crafty.lastEvent;"touchstart"===a.type?b="mousedown":"touchmove"===a.type?b="mousemove":"touchend"===a.type?b="mouseup":"touchcancel"===a.type?b="mouseup":"touchleave"===a.type&&(b="mouseup"),a.touches&&a.touches.length?first=a.touches[0]:a.changedTouches&&a.changedTouches.length&&(first=a.changedTouches[0]);var d=document.createEvent("MouseEvent");if(d.initMouseEvent(b,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,a.relatedTarget),first.target.dispatchEvent(d),null!=c&&"mousedown"==c.type&&"mouseup"==b){b="click";var d=document.createEvent("MouseEvent");d.initMouseEvent(b,!0,!0,window,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,a.relatedTarget),first.target.dispatchEvent(d)}a.preventDefault?a.preventDefault():a.returnValue=!1},keyboardDispatch:function(a){for(var b=a,c={},d="char charCode keyCode type shiftKey ctrlKey metaKey timestamp".split(" "),e=d.length;e;){var f=d[--e];c[f]=b[f]}if(c.which=null!=b.charCode?b.charCode:b.keyCode,c.key=b.keyCode||b.which,c.originalEvent=b,a=c,"keydown"===a.type?Crafty.keydown[a.key]!==!0&&(Crafty.keydown[a.key]=!0,Crafty.trigger("KeyDown",a)):"keyup"===a.type&&(delete Crafty.keydown[a.key],Crafty.trigger("KeyUp",a)),Crafty.selected&&!(8==a.key||a.key>=112&&a.key<=135))return a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,a.target&&"INPUT"!==a.target.nodeName&&"TEXTAREA"!==a.target.nodeName&&(a.preventDefault?a.preventDefault():a.returnValue=!1),!1}}),Crafty.bind("Load",function(){Crafty.addEvent(this,"keydown",Crafty.keyboardDispatch),Crafty.addEvent(this,"keyup",Crafty.keyboardDispatch),Crafty.addEvent(this,Crafty.stage.elem,"mousedown",Crafty.mouseDispatch),Crafty.addEvent(this,Crafty.stage.elem,"mouseup",Crafty.mouseDispatch),Crafty.addEvent(this,document.body,"mouseup",Crafty.detectBlur),Crafty.addEvent(this,Crafty.stage.elem,"mousemove",Crafty.mouseDispatch),Crafty.addEvent(this,Crafty.stage.elem,"click",Crafty.mouseDispatch),Crafty.addEvent(this,Crafty.stage.elem,"dblclick",Crafty.mouseDispatch),Crafty.addEvent(this,Crafty.stage.elem,"touchstart",Crafty.touchDispatch),Crafty.addEvent(this,Crafty.stage.elem,"touchmove",Crafty.touchDispatch),Crafty.addEvent(this,Crafty.stage.elem,"touchend",Crafty.touchDispatch),Crafty.addEvent(this,Crafty.stage.elem,"touchcancel",Crafty.touchDispatch),Crafty.addEvent(this,Crafty.stage.elem,"touchleave",Crafty.touchDispatch)}),Crafty.bind("CraftyStop",function(){Crafty.removeEvent(this,"keydown",Crafty.keyboardDispatch),Crafty.removeEvent(this,"keyup",Crafty.keyboardDispatch),Crafty.stage&&(Crafty.removeEvent(this,Crafty.stage.elem,"mousedown",Crafty.mouseDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",Crafty.mouseDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",Crafty.mouseDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"click",Crafty.mouseDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"dblclick",Crafty.mouseDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"touchstart",Crafty.touchDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"touchmove",Crafty.touchDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"touchend",Crafty.touchDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"touchcancel",Crafty.touchDispatch),Crafty.removeEvent(this,Crafty.stage.elem,"touchleave",Crafty.touchDispatch)),Crafty.removeEvent(this,document.body,"mouseup",Crafty.detectBlur)}),Crafty.c("Mouse",{init:function(){Crafty.mouseObjs++,this.bind("Remove",function(){Crafty.mouseObjs--})},areaMap:function(a){if(arguments.length>1){var b=Array.prototype.slice.call(arguments,0);a=new Crafty.polygon(b)}return a.shift(this._x,this._y),this.mapArea=a,this.attach(this.mapArea),this}}),Crafty.c("Draggable",{_origMouseDOMPos:null,_oldX:null,_oldY:null,_dragging:!1,_dir:null,_ondrag:null,_ondown:null,_onup:null,init:function(){this.requires("Mouse"),this._ondrag=function(a){var b=Crafty.DOM.translate(a.clientX,a.clientY);if(0==b.x||0==b.y)return!1;if(this._dir){var c=(b.x-this._origMouseDOMPos.x)*this._dir.x+(b.y-this._origMouseDOMPos.y)*this._dir.y;this.x=this._oldX+c*this._dir.x,this.y=this._oldY+c*this._dir.y}else this.x=this._oldX+(b.x-this._origMouseDOMPos.x),this.y=this._oldY+(b.y-this._origMouseDOMPos.y);this.trigger("Dragging",a)},this._ondown=function(a){a.mouseButton===Crafty.mouseButtons.LEFT&&this._startDrag(a)},this._onup=function(a){1==this._dragging&&(Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",this._ondrag),Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",this._onup),this._dragging=!1,this.trigger("StopDrag",a))},this.enableDrag()},dragDirection:function(a){if("undefined"==typeof a)this._dir=null;else if(""+parseInt(a)==a)this._dir={x:Math.cos(a/180*Math.PI),y:Math.sin(a/180*Math.PI)};else{var b=Math.sqrt(a.x*a.x+a.y*a.y);this._dir={x:a.x/b,y:a.y/b}}},_startDrag:function(a){this._origMouseDOMPos=Crafty.DOM.translate(a.clientX,a.clientY),this._oldX=this._x,this._oldY=this._y,this._dragging=!0,Crafty.addEvent(this,Crafty.stage.elem,"mousemove",this._ondrag),Crafty.addEvent(this,Crafty.stage.elem,"mouseup",this._onup),this.trigger("StartDrag",a)},stopDrag:function(){return Crafty.removeEvent(this,Crafty.stage.elem,"mousemove",this._ondrag),Crafty.removeEvent(this,Crafty.stage.elem,"mouseup",this._onup),this._dragging=!1,this.trigger("StopDrag"),this},startDrag:function(){return this._dragging||this._startDrag(Crafty.lastEvent),this},enableDrag:function(){return this.bind("MouseDown",this._ondown),Crafty.addEvent(this,Crafty.stage.elem,"mouseup",this._onup),this},disableDrag:function(){return this.unbind("MouseDown",this._ondown),this._dragging&&this.stopDrag(),this}}),Crafty.c("Keyboard",{isDown:function(a){return"string"==typeof a&&(a=Crafty.keys[a]),!!Crafty.keydown[a]}}),Crafty.c("Multiway",{_speed:3,_keydown:function(a){this._keys[a.key]&&(this._movement.x=Math.round(1e3*(this._movement.x+this._keys[a.key].x))/1e3,this._movement.y=Math.round(1e3*(this._movement.y+this._keys[a.key].y))/1e3,this.trigger("NewDirection",this._movement))},_keyup:function(a){this._keys[a.key]&&(this._movement.x=Math.round(1e3*(this._movement.x-this._keys[a.key].x))/1e3,this._movement.y=Math.round(1e3*(this._movement.y-this._keys[a.key].y))/1e3,this.trigger("NewDirection",this._movement))},_enterframe:function(){this.disableControls||(0!==this._movement.x&&(this.x+=this._movement.x,this.trigger("Moved",{x:this.x-this._movement.x,y:this.y})),0!==this._movement.y&&(this.y+=this._movement.y,this.trigger("Moved",{x:this.x,y:this.y-this._movement.y})))},_initializeControl:function(){return this.unbind("KeyDown",this._keydown).unbind("KeyUp",this._keyup).unbind("EnterFrame",this._enterframe).bind("KeyDown",this._keydown).bind("KeyUp",this._keyup).bind("EnterFrame",this._enterframe)},multiway:function(a,b){this._keyDirection={},this._keys={},this._movement={x:0,y:0},this._speed={x:3,y:3},b?void 0!==a.x&&void 0!==a.y?(this._speed.x=a.x,this._speed.y=a.y):(this._speed.x=a,this._speed.y=a):b=a,this._keyDirection=b,this.speed(this._speed),this._initializeControl();for(var c in b)Crafty.keydown[Crafty.keys[c]]&&this.trigger("KeyDown",{key:Crafty.keys[c]});return this},enableControl:function(){return this.disableControls=!1,this},disableControl:function(){return this.disableControls=!0,this},speed:function(a){for(var b in this._keyDirection){var c=Crafty.keys[b]||b;this._keys[c]={x:Math.round(1e3*Math.cos(this._keyDirection[b]*(Math.PI/180))*a.x)/1e3,y:Math.round(1e3*Math.sin(this._keyDirection[b]*(Math.PI/180))*a.y)/1e3}}return this}}),Crafty.c("Fourway",{init:function(){this.requires("Multiway")},fourway:function(a){return this.multiway(a,{UP_ARROW:-90,DOWN_ARROW:90,RIGHT_ARROW:0,LEFT_ARROW:180,W:-90,S:90,D:0,A:180,Z:-90,Q:180}),this}}),Crafty.c("Twoway",{_speed:3,_up:!1,init:function(){this.requires("Fourway, Keyboard")},twoway:function(a,b){return this.multiway(a,{RIGHT_ARROW:0,LEFT_ARROW:180,D:0,A:180,Q:180}),a&&(this._speed=a),arguments.length<2&&(b=2*this._speed),this.bind("EnterFrame",function(){this.disableControls||this._up&&(this.y-=b,this._falling=!0)}).bind("KeyDown",function(){(this.isDown("UP_ARROW")||this.isDown("W")||this.isDown("Z"))&&(this._up=!0)}),this}}),Crafty.c("SpriteAnimation",{_reels:null,_currentReelId:null,_isPlaying:!1,_frameChangeInfo:{reelId:void 0,frameNumber:void 0},_animationEndInfo:{reelId:void 0},init:function(){this._reels={}},animate:function(a,b,c,d){var e,f,g,h,i;if(g=this.__tile+parseInt(this.__padding[0]||0,10),h=this.__tileh+parseInt(this.__padding[1]||0,10),e={frames:[],cyclesPerFrame:void 0,currentFrameNumber:0,cycleNumber:0,repeatsRemaining:0},"number"==typeof b)if(f=b,d>b)for(;f<=d;f++)e.frames.push([f*g,c*h]);else for(;f>=d;f--)e.frames.push([f*g,c*h]);else{if(2!==arguments.length)throw"Urecognized arguments. Please see the documentation for 'animate(...)'.";for(f=0,d=b.length-1;f<=d;f++)i=b[f],e.frames.push([i[0]*g,i[1]*h])}return this._reels[a]=e,this},playAnimation:function(a,b,c,d){var e;if(currentReel=this._reels[a],void 0===currentReel)throw"The supplied reelId, "+a+", is not recognized.";if(this.pauseAnimation(),this._currentReelId=a,void 0!==b&&null!==b&&(currentReel.cyclesPerFrame=Math.ceil(b/currentReel.frames.length)),void 0===c||null===c?currentReel.repeatsRemaining=0:c===-1?currentReel.repeatsRemaining=1/0:currentReel.repeatsRemaining=c,void 0!==d&&null!==d){if(d>=currentReel.frames.length)throw"The request frame exceeds the reel length.";currentReel.currentFrameNumber=d,currentReel.cycleNumber=0}return this._frameChangeInfo.reelId=this._currentReelId,this._frameChangeInfo.frameNumber=currentReel.currentFrameNumber,this.trigger("FrameChange",this._frameChangeInfo),this.trigger("Change"),e=currentReel.frames[currentReel.currentFrameNumber],this.__coord[0]=e[0],this.__coord[1]=e[1],this.bind("EnterFrame",this.updateSprite),this._isPlaying=!0,this},resumeAnimation:function(a){if(void 0===a||null===a){
if(null!==this._currentReelId)return this.playAnimation(this._currentReelId,null);throw"There is no animation to resume."}return this.playAnimation(a,null)},updateSprite:function(){var a=this._reels[this._currentReelId];if(a.cycleNumber++,a.cycleNumber===a.cyclesPerFrame){if(a.currentFrameNumber++,a.cycleNumber=0,a.currentFrameNumber>=a.frames.length){if(!(a.repeatsRemaining>0))return a.currentFrameNumber=a.frames.length-1,this.pauseAnimation(),this._animationEndInfo.reelId=this._currentReelId,void this.trigger("AnimationEnd",this._animationEndInfo);a.repeatsRemaining--,a.currentFrameNumber=0}this._frameChangeInfo.reelId=this._currentReelId,this._frameChangeInfo.frameNumber=a.currentFrameNumber,this.trigger("FrameChange",this._frameChangeInfo),this.trigger("Change")}var b=a.frames[a.currentFrameNumber];this.__coord[0]=b[0],this.__coord[1]=b[1]},pauseAnimation:function(){return this.unbind("EnterFrame",this.updateSprite),this._isPlaying=!1,this},resetAnimation:function(a,b){var c=this._reels[a];if(void 0===a||null===a){if(null===this._currentReelId)return this;c=this._reels[this._currentReelId]}if(void 0!==b&&null!==b||(b=0),void 0===c)throw"The supplied reelId, "+a+", is not recognized.";if(b>=c.frames.length)throw"The request frame exceeds the reel length.";this.pauseAnimation(),c.cyclesPerFrame=void 0,c.currentFrameNumber=b,c.cycleNumber=0,c.repeatsRemaining=0,this.trigger("Change");var d=c.frames[b];return this.__coord[0]=d[0],this.__coord[1]=d[1],this},isPlaying:function(a){return!!this._isPlaying&&(a?this._currentReelId===a:!!this._currentReelId)},getActiveReel:function(){return this._currentReelId?{id:this._currentReelId,frame:this._reels[this._currentReelId].currentFrameNumber}:{id:null,frame:0}}}),Crafty.c("Tween",{_step:null,_numProps:0,tween:function(a,b){return this.each(function(){null==this._step&&(this._step={},this.bind("EnterFrame",tweenEnterFrame),this.bind("RemoveComponent",function(a){"Tween"==a&&this.unbind("EnterFrame",tweenEnterFrame)}));for(var c in a)this._step[c]={prop:a[c],val:(a[c]-this[c])/b,rem:b},this._numProps++}),this}}),Crafty.c("Color",{_color:"",ready:!0,init:function(){this.bind("Draw",function(a){"DOM"===a.type?(a.style.background=this._color,a.style.lineHeight=0):"canvas"===a.type&&(this._color&&(a.ctx.fillStyle=this._color),a.ctx.fillRect(a.pos._x,a.pos._y,a.pos._w,a.pos._h))})},color:function(a){return a?(this._color=a,this.trigger("Change"),this):this._color}}),Crafty.c("Tint",{_color:null,_strength:1,init:function(){var a=function(a){var b=a.ctx||Crafty.canvas.context;b.fillStyle=this._color||"rgba(0,0,0, 0)",b.fillRect(a.pos._x,a.pos._y,a.pos._w,a.pos._h)};this.bind("Draw",a).bind("RemoveComponent",function(b){"Tint"===b&&this.unbind("Draw",a)})},tint:function(a,b){return this._strength=b,this._color=Crafty.toRGB(a,this._strength),this.trigger("Change"),this}}),Crafty.c("Image",{_repeat:"repeat",ready:!1,init:function(){var a=function(a){if("canvas"===a.type){if(!this.ready||!this._pattern)return;var b=a.ctx;b.fillStyle=this._pattern,b.save(),b.translate(a.pos._x,a.pos._y),b.fillRect(0,0,this._w,this._h),b.restore()}else"DOM"===a.type&&this.__image&&(a.style.background="url("+this.__image+") "+this._repeat)};this.bind("Draw",a).bind("RemoveComponent",function(b){"Image"===b&&this.unbind("Draw",a)})},image:function(a,b){if(this.__image=a,this._repeat=b||"no-repeat",this.img=Crafty.asset(a),!this.img){this.img=new Image,Crafty.asset(a,this.img),this.img.src=a;var c=this;return this.img.onload=function(){c.has("Canvas")&&(c._pattern=Crafty.canvas.context.createPattern(c.img,c._repeat)),c.ready=!0,"no-repeat"===c._repeat&&(c.w=c.img.width,c.h=c.img.height),c.trigger("Change")},this}return this.ready=!0,this.has("Canvas")&&(this._pattern=Crafty.canvas.context.createPattern(this.img,this._repeat)),"no-repeat"===this._repeat&&(this.w=this.img.width,this.h=this.img.height),this.trigger("Change"),this}}),Crafty.extend({_scenes:{},_current:null,scene:function(a,b,c){if(1===arguments.length){Crafty.trigger("SceneDestroy",{newScene:a}),Crafty.viewport.reset(),Crafty("2D").each(function(){this.has("Persist")||this.destroy()}),null!==this._current&&"uninitialize"in this._scenes[this._current]&&this._scenes[this._current].uninitialize.call(this);var d=this._current;return this._current=a,Crafty.trigger("SceneChange",{oldScene:d,newScene:a}),void this._scenes[a].initialize.call(this)}this._scenes[a]={},this._scenes[a].initialize=b,"undefined"!=typeof c&&(this._scenes[a].uninitialize=c)},toRGB:function(a,b){var c,a="#"===a.charAt(0)?a.substr(1):a,d=[];return d[0]=parseInt(a.substr(0,2),16),d[1]=parseInt(a.substr(2,2),16),d[2]=parseInt(a.substr(4,2),16),c=void 0===b?"rgb("+d.join(",")+")":"rgba("+d.join(",")+","+b+")"}}),Crafty.DrawManager=function(){function a(a,b){return a._globalZ-b._globalZ}var b=[],c=[],d=[],e=!1,f={merge:function(a,b,c){return null==c&&(c={}),c._h=Math.max(a._y+a._h,b._y+b._h),c._w=Math.max(a._x+a._w,b._x+b._w),c._x=~~Math.min(a._x,b._x),c._y=~~Math.min(a._y,b._y),c._w-=c._x,c._h-=c._y,c._w=c._w==~~c._w?c._w:~~c._w+1|0,c._h=c._h==~~c._h?c._h:~~c._h+1|0,c},clean:function(){var a,d,e;for(e=0,l=c.length;e<l;e++)d=c[e],a=d._mbr||d,null==d.staleRect&&(d.staleRect={}),d.staleRect._x=a._x,d.staleRect._y=a._y,d.staleRect._w=a._w,d.staleRect._h=a._h,d._changed=!1;c.length=0,b.length=0},createDirty:function(a){var c=a._mbr||a;if(a.staleRect){if(f.overlap(a.staleRect,c))return f.merge(a.staleRect,c,a.staleRect),void b.push(a.staleRect);b.push(a.staleRect)}a.currentRect._x=c._x,a.currentRect._y=c._y,a.currentRect._w=c._w,a.currentRect._h=c._h,b.push(a.currentRect)},overlap:function(a,b){return a._x<b._x+b._w&&a._y<b._y+b._h&&a._x+a._w>b._x&&a._y+a._h>b._y}};return Crafty.bind("InvalidateViewport",function(){e=!0}),Crafty.bind("PostRender",function(){e=!1}),{total2D:Crafty("2D").length,onScreen:function(a){return Crafty.viewport._x+a._x+a._w>0&&Crafty.viewport._y+a._y+a._h>0&&Crafty.viewport._x+a._x<Crafty.viewport.width&&Crafty.viewport._y+a._y<Crafty.viewport.height},mergeSet:function(a){for(var b=0;b<a.length-1;)f.overlap(a[b],a[b+1])?(f.merge(a[b],a[b+1],a[b]),a.splice(b+1,1),b>0&&b--):b++;return a},addCanvas:function(a){c.push(a)},addDom:function(a){d.push(a)},debug:function(){console.log(c,d)},drawAll:function(b){var c,b=b||Crafty.viewport.rect(),d=Crafty.map.search(b),e=0,f=d.length,g=Crafty.canvas.context;for(g.clearRect(b._x,b._y,b._w,b._h),d.sort(a);e<f;e++)c=d[e],c._visible&&c.__c.Canvas&&(c.draw(),c._changed=!1)},boundingRect:function(a){if(a&&a.length){var b,c,d=1,e=a.length,f=a[0];for(f=[f._x,f._y,f._x+f._w,f._y+f._h];d<e;)b=a[d],c=[b._x,b._y,b._x+b._w,b._y+b._h],c[0]<f[0]&&(f[0]=c[0]),c[1]<f[1]&&(f[1]=c[1]),c[2]>f[2]&&(f[2]=c[2]),c[3]>f[3]&&(f[3]=c[3]),d++;return c=f,f={_x:c[0],_y:c[1],_w:c[2]-c[0],_h:c[3]-c[1]}}},renderCanvas:function(){var d=c.length;if(d||e){var g,h,i,j,k,l=0,d=c.length,m=Crafty.canvas.context,n=Crafty.DrawManager;if(e){var o=Crafty.viewport;m.setTransform(o._scale,0,0,o._scale,o.x,o.y)}if(d/n.total2D>.6||e)return n.drawAll(),void f.clean();for(l=0;l<d;l++)f.createDirty(c[l]);b=n.mergeSet(b),d=b.length;var p=[],q=[];for(l=0;l<d;++l)if(g=b[l],p.length=0,q.length=0,g){for(h=Crafty.map.search(g,!1),m.clearRect(g._x,g._y,g._w,g._h),m.save(),m.beginPath(),m.rect(g._x,g._y,g._w,g._h),m.clip(),i=0,j=h.length;i<j;++i)k=h[i],!p[k[0]]&&k._visible&&k.__c.Canvas&&(p[k[0]]=!0,q.push(k));for(q.sort(a),i=0,j=q.length;i<j;++i){k=q[i];var r=k._mbr||k;f.overlap(r,g)&&k.draw(),k._changed=!1}m.closePath(),m.restore()}if(Crafty.DrawManager.debugDirty===!0)for(m.strokeStyle="red",l=0,d=b.length;l<d;++l)g=b[l],m.strokeRect(g._x,g._y,g._w,g._h);f.clean()}},renderDOM:function(){if(e){var a=Crafty.stage.inner.style,b=Crafty.viewport;a.transform=a[Crafty.support.prefix+"Transform"]="scale("+b._scale+", "+b._scale+")",a.left=b.x+"px",a.top=b.y+"px",a.zIndex=10}if(d.length){for(var c=0,f=d.length;c<f;++c)d[c].draw()._changed=!1;d.length=0}}}}(),Crafty.extend({isometric:{_tile:{width:0,height:0},_elements:{},_pos:{x:0,y:0},_z:0,size:function(a,b){return this._tile.width=a,this._tile.height=b>0?b:a/2,this},place:function(a,b,c,d){var e=this.pos2px(a,b);return e.top-=c*(this._tile.height/2),d.attr({x:e.left+Crafty.viewport._x,y:e.top+Crafty.viewport._y}).z+=c,this},pos2px:function(a,b){return{left:a*this._tile.width+(1&b)*(this._tile.width/2),top:b*this._tile.height/2}},px2pos:function(a,b){return{x:Math.ceil(-a/this._tile.width-.5*(1&b)),y:-b/this._tile.height*2}},centerAt:function(a,b){if("number"==typeof a&&"number"==typeof b){var c=this.pos2px(a,b);return Crafty.viewport._x=-c.left+Crafty.viewport.width/2-this._tile.width/2,Crafty.viewport._y=-c.top+Crafty.viewport.height/2-this._tile.height/2,this}return{top:-Crafty.viewport._y+Crafty.viewport.height/2-this._tile.height/2,left:-Crafty.viewport._x+Crafty.viewport.width/2-this._tile.width/2}},area:function(){var a=this.centerAt(),b=this.px2pos(-a.left+Crafty.viewport.width/2,-a.top+Crafty.viewport.height/2),c=this.px2pos(-a.left-Crafty.viewport.width/2,-a.top-Crafty.viewport.height/2);return{x:{start:b.x,end:c.x},y:{start:b.y,end:c.y}}}}}),Crafty.extend({diamondIso:{_tile:{width:0,height:0,r:0},_map:{width:0,height:0,x:0,y:0},_origin:{x:0,y:0},init:function(a,b,c,d){return this._tile.width=parseInt(a),this._tile.height=parseInt(b)||parseInt(a)/2,this._tile.r=this._tile.width/this._tile.height,this._map.width=parseInt(c),this._map.height=parseInt(d)||parseInt(c),this._origin.x=this._map.height*this._tile.width/2,this},place:function(a,b,c,d){var e=this.pos2px(b,c);d||(d=1);var f=0,g=0;void 0!==a.__margin&&(f=a.__margin[0],g=a.__margin[1]),a.x=e.left+f,a.y=e.top+g-a.h,a.z=e.top*d},centerAt:function(a,b){var c=this.pos2px(a,b);Crafty.viewport.x=-c.left+Crafty.viewport.width/2-this._tile.width,Crafty.viewport.y=-c.top+Crafty.viewport.height/2},area:function(a){a||(a=0);var b=Crafty.viewport.rect(),c=a*this._tile.width,d=a*this._tile.height;b._x-=this._tile.width/2+c,b._y-=this._tile.height/2+d,b._w+=this._tile.width/2+c,b._h+=this._tile.height/2+d;for(var e=[],f=b._y,g=b._y+b._h;f<g;f+=this._tile.height/2)for(var h=b._x,i=b._x+b._w;h<i;h+=this._tile.width/2){var j=this.px2pos(h,f);e.push([~~j.x,~~j.y])}return e},pos2px:function(a,b){return{left:(a-b)*this._tile.width/2+this._origin.x,top:(a+b)*this._tile.height/2}},px2pos:function(a,b){var c=(a-this._origin.x)/this._tile.r;return{x:(b+c)/this._tile.height,y:(b-c)/this._tile.height}},polygon:function(a){a.requires("Collision");var b=0,c=0;void 0!==a.__margin&&(b=a.__margin[0],c=a.__margin[1]);var d=[[b-0,a.h-c-this._tile.height/2],[b-this._tile.width/2,a.h-c-0],[b-this._tile.width,a.h-c-this._tile.height/2],[b-this._tile.width/2,a.h-c-this._tile.height]],e=new Crafty.polygon(d);return e}}}),Crafty.c("Particles",{init:function(){this._Particles=Crafty.clone(this._Particles)},particles:function(a){if(!Crafty.support.canvas||Crafty.deactivateParticles)return this;var b,c,d,e,f;b=document.createElement("canvas"),b.width=Crafty.viewport.width,b.height=Crafty.viewport.height,b.style.position="absolute",b.style.left="0px",b.style.top="0px",Crafty.stage.elem.appendChild(b),c=b.getContext("2d"),this._Particles.init(a),this.bind("Remove",function(){Crafty.stage.elem.removeChild(b)}).bind("RemoveComponent",function(a){"particles"===a&&Crafty.stage.elem.removeChild(b)}),d=this.x+Crafty.viewport.x,e=this.y+Crafty.viewport.y,this._Particles.position=this._Particles.vectorHelpers.create(d,e);var g={x:Crafty.viewport.x,y:Crafty.viewport.y};return this.bind("EnterFrame",function(){d=this.x+Crafty.viewport.x,e=this.y+Crafty.viewport.y,this._Particles.viewportDelta={x:Crafty.viewport.x-g.x,y:Crafty.viewport.y-g.y},g={x:Crafty.viewport.x,y:Crafty.viewport.y},this._Particles.position=this._Particles.vectorHelpers.create(d,e),"function"==typeof Crafty.DrawManager.boundingRect?(f=Crafty.DrawManager.boundingRect(this._Particles.register),f&&c.clearRect(f._x,f._y,f._w,f._h)):c.clearRect(0,0,Crafty.viewport.width,Crafty.viewport.height),this._Particles.update(),this._Particles.render(c)}),this},_Particles:{presets:{maxParticles:150,size:18,sizeRandom:4,speed:1,speedRandom:1.2,lifeSpan:29,lifeSpanRandom:7,angle:65,angleRandom:34,startColour:[255,131,0,1],startColourRandom:[48,50,45,0],endColour:[245,35,0,0],endColourRandom:[60,60,60,0],sharpness:20,sharpnessRandom:10,spread:10,duration:-1,fastMode:!1,gravity:{x:0,y:.1},jitter:0,particles:[],active:!0,particleCount:0,elapsedFrames:0,emissionRate:0,emitCounter:0,particleIndex:0},init:function(a){if(this.position=this.vectorHelpers.create(0,0),"undefined"==typeof a)var a={};for(key in this.presets)"undefined"!=typeof a[key]?this[key]=a[key]:this[key]=this.presets[key];this.emissionRate=this.maxParticles/this.lifeSpan,this.positionRandom=this.vectorHelpers.create(this.spread,this.spread)},addParticle:function(){if(this.particleCount==this.maxParticles)return!1;var a=new this.particle(this.vectorHelpers);return this.initParticle(a),this.particles[this.particleCount]=a,this.particleCount++,!0},RANDM1TO1:function(){return 2*Math.random()-1},initParticle:function(a){a.position.x=this.position.x+this.positionRandom.x*this.RANDM1TO1(),a.position.y=this.position.y+this.positionRandom.y*this.RANDM1TO1();var b=(this.angle+this.angleRandom*this.RANDM1TO1())*(Math.PI/180),c=this.vectorHelpers.create(Math.sin(b),-Math.cos(b)),d=this.speed+this.speedRandom*this.RANDM1TO1();a.direction=this.vectorHelpers.multiply(c,d),a.size=this.size+this.sizeRandom*this.RANDM1TO1(),a.size=a.size<0?0:~~a.size,a.timeToLive=this.lifeSpan+this.lifeSpanRandom*this.RANDM1TO1(),a.sharpness=this.sharpness+this.sharpnessRandom*this.RANDM1TO1(),a.sharpness=a.sharpness>100?100:a.sharpness<0?0:a.sharpness,a.sizeSmall=~~(a.size/200*a.sharpness);var e=[this.startColour[0]+this.startColourRandom[0]*this.RANDM1TO1(),this.startColour[1]+this.startColourRandom[1]*this.RANDM1TO1(),this.startColour[2]+this.startColourRandom[2]*this.RANDM1TO1(),this.startColour[3]+this.startColourRandom[3]*this.RANDM1TO1()],f=[this.endColour[0]+this.endColourRandom[0]*this.RANDM1TO1(),this.endColour[1]+this.endColourRandom[1]*this.RANDM1TO1(),this.endColour[2]+this.endColourRandom[2]*this.RANDM1TO1(),this.endColour[3]+this.endColourRandom[3]*this.RANDM1TO1()];a.colour=e,a.deltaColour[0]=(f[0]-e[0])/a.timeToLive,a.deltaColour[1]=(f[1]-e[1])/a.timeToLive,a.deltaColour[2]=(f[2]-e[2])/a.timeToLive,a.deltaColour[3]=(f[3]-e[3])/a.timeToLive},update:function(){if(this.active&&this.emissionRate>0){var a=1/this.emissionRate;for(this.emitCounter++;this.particleCount<this.maxParticles&&this.emitCounter>a;)this.addParticle(),this.emitCounter-=a;this.elapsedFrames++,this.duration!=-1&&this.duration<this.elapsedFrames&&this.stop()}this.particleIndex=0,this.register=[];for(var b;this.particleIndex<this.particleCount;){var c=this.particles[this.particleIndex];if(c.timeToLive>0){c.direction=this.vectorHelpers.add(c.direction,this.gravity),c.position=this.vectorHelpers.add(c.position,c.direction),c.position=this.vectorHelpers.add(c.position,this.viewportDelta),this.jitter&&(c.position.x+=this.jitter*this.RANDM1TO1(),c.position.y+=this.jitter*this.RANDM1TO1()),c.timeToLive--;var d=c.colour[0]+=c.deltaColour[0],e=c.colour[1]+=c.deltaColour[1],f=c.colour[2]+=c.deltaColour[2],g=c.colour[3]+=c.deltaColour[3];b=[],b.push("rgba("+(d>255?255:d<0?0:~~d)),b.push(e>255?255:e<0?0:~~e),b.push(f>255?255:f<0?0:~~f),b.push((g>1?1:g<0?0:g.toFixed(2))+")"),c.drawColour=b.join(","),this.fastMode||(b[3]="0)",c.drawColourEnd=b.join(",")),this.particleIndex++}else this.particleIndex!=this.particleCount-1&&(this.particles[this.particleIndex]=this.particles[this.particleCount-1]),this.particleCount--;var h={};h._x=~~c.position.x,h._y=~~c.position.y,h._w=c.size,h._h=c.size,this.register.push(h)}},stop:function(){this.active=!1,this.elapsedFrames=0,this.emitCounter=0},render:function(a){for(var b=0,c=this.particleCount;b<c;b++){var d=this.particles[b],e=d.size,f=e>>1;if(!(d.position.x+e<0||d.position.y+e<0||d.position.x-e>Crafty.viewport.width||d.position.y-e>Crafty.viewport.height)){var g=~~d.position.x,h=~~d.position.y;if(this.fastMode)a.fillStyle=d.drawColour;else{var i=a.createRadialGradient(g+f,h+f,d.sizeSmall,g+f,h+f,f);i.addColorStop(0,d.drawColour),i.addColorStop(.9,d.drawColourEnd),a.fillStyle=i}a.fillRect(g,h,e,e)}}},particle:function(a){this.position=a.create(0,0),this.direction=a.create(0,0),this.size=0,this.sizeSmall=0,this.timeToLive=0,this.colour=[],this.drawColour="",this.deltaColour=[],this.sharpness=0},vectorHelpers:{create:function(a,b){return{x:a,y:b}},multiply:function(a,b){return a.x*=b,a.y*=b,a},add:function(a,b){return a.x+=b.x,a.y+=b.y,a}}}}),Crafty.extend({audio:{sounds:{},supported:null,codecs:{ogg:'audio/ogg; codecs="vorbis"',wav:'audio/wav; codecs="1"',webma:'audio/webm; codecs="vorbis"',mp3:'audio/mpeg; codecs="mp3"',m4a:'audio/mp4; codecs="mp4a.40.2"'},volume:1,muted:!1,paused:!1,playCheck:null,_canPlay:function(){if(this.supported={},Crafty.support.audio){var a,b=this.audioElement();for(var c in this.codecs)a=b.canPlayType(this.codecs[c]),""!==a&&"no"!==a?this.supported[c]=!0:this.supported[c]=!1}},supports:function(a){return null===this.supported&&this._canPlay(),!!this.supported[a]},audioElement:function(){return"undefined"!=typeof Audio?new Audio(""):document.createElement("audio")},create:function(a,b){var c=b.substr(b.lastIndexOf(".")+1).toLowerCase();if(!this.supports(c))return!1;var d=this.audioElement();return d.id=a,d.preload="auto",d.volume=Crafty.audio.volume,d.src=b,Crafty.asset(b,d),this.sounds[a]={obj:d,played:0,volume:Crafty.audio.volume},this.sounds[a]},add:function(a,b){if(Crafty.support.audio){if(1===arguments.length&&"object"==typeof a)for(var c in a)for(var d in a[c])if(Crafty.audio.create(c,a[c][d]))break;if("string"==typeof a&&("string"==typeof b&&Crafty.audio.create(a,b),"object"==typeof b))for(d in b)if(Crafty.audio.create(a,b[d]))break}},play:function(a,b,c){if(0!=b&&Crafty.support.audio&&this.sounds[a]){var d=this.sounds[a],e=this.getOpenChannel();if(e){e.id=a;var f=e.obj;e.volume=d.volume=d.obj.volume=c||Crafty.audio.volume,f.volume=d.volume,f.src=d.obj.src,this.muted&&(f.volume=0),f.play(),d.played++,e.onEnd=function(){d.played<b||b==-1?(this.currentTime&&(this.currentTime=0),this.play(),d.played++):(e.active=!1,this.pause(),this.removeEventListener("ended",e.onEnd,!0),this.currentTime=0,Crafty.trigger("SoundComplete",{id:e.id}))},f.addEventListener("ended",e.onEnd,!0)}}},maxChannels:7,setChannels:function(a){this.maxChannels=a,a>channels.length&&(this.channels.length=a)},channels:[],getOpenChannel:function(){for(var a=0;a<this.channels.length;a++)if(this.channels[a].active===!1)return this.channels[a].active=!0,this.channels[a];if(a<=this.maxChannels){var b={obj:this.audioElement(),active:!0,_is:function(a){return this.id===a&&this.active}};return this.channels.push(b),b}return null},remove:function(a){if(Crafty.support.audio){var b;if(a)this.sounds[a]&&(b=this.sounds[a],Crafty.audio.stop(a),delete Crafty.assets[b.obj.src],delete Crafty.audio.sounds[a]);else for(var c in this.sounds)b=this.sounds[c],Crafty.audio.stop(a),delete Crafty.assets[b.obj.src],delete Crafty.audio.sounds[a]}},stop:function(a){if(Crafty.support.audio){var b;if(a)b=this.sounds[a],b&&(b.obj.paused||b.obj.pause());else for(var d in this.channels)c=this.channels[d],c.active&&(c.active=!1,c.obj.pause())}},_mute:function(a){if(Crafty.support.audio){var b;for(var c in this.channels)b=this.channels[c],b.obj.volume=a?0:b.volume;this.muted=a}},toggleMute:function(){this.muted?this._mute(!1):this._mute(!0)},mute:function(){this._mute(!0)},unmute:function(){this._mute(!1)},pause:function(a){if(Crafty.support.audio&&a&&this.sounds[a]){var b;for(var c in this.channels)b=this.channels[c],b._is(a)&&!b.obj.paused&&b.obj.pause()}},unpause:function(a){if(Crafty.support.audio&&a&&this.sounds[a]){var b;for(var c in this.channels)b=this.channels[c],b._is(a)&&b.obj.paused&&b.obj.play()}},togglePause:function(a){if(Crafty.support.audio&&a&&this.sounds[a]){var b;for(var c in this.channels)b=this.channels[c],b._is(a)&&(b.obj.paused?b.obj.play():b.obj.pause())}}}}),Crafty.c("Text",{_text:"",defaultSize:"10px",defaultFamily:"sans-serif",ready:!0,init:function(){this.requires("2D"),this._textFont={type:"",weight:"",size:"",family:""},this.bind("Draw",function(a){var b=this._textFont.type+" "+this._textFont.weight+" "+(this._textFont.size||this.defaultSize)+" "+(this._textFont.family||this.defaultFamily);if("DOM"===a.type){var c=this._element,d=c.style;d.color=this._textColor,d.font=b,c.innerHTML=this._text}else if("canvas"===a.type){var e=a.ctx,f=null;e.save(),e.fillStyle=this._textColor||"rgb(0,0,0)",e.font=b,e.translate(this.x,this.y+this.h),e.fillText(this._text,0,0),f=e.measureText(this._text),this._w=f.width,e.restore()}})},text:function(a){return"undefined"==typeof a||null===a?this._text:("function"==typeof a?this._text=a.call(this):this._text=a,this.trigger("Change"),this)},textColor:function(a,b){return this._strength=b,this._textColor=Crafty.toRGB(a,this._strength),this.trigger("Change"),this},textFont:function(a,b){if(1===arguments.length){if("string"==typeof a)return this._textFont[a];if("object"==typeof a)for(propertyKey in a)this._textFont[propertyKey]=a[propertyKey]}else this._textFont[a]=b;return this.trigger("Change"),this},unselectable:function(){return this.has("DOM")&&(this.css({"-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none"}),this.trigger("Change")),this}}),Crafty.extend({assets:{},asset:function(a,b){return 1===arguments.length?Crafty.assets[a]:void(Crafty.assets[a]||(Crafty.assets[a]=b,this.trigger("NewAsset",{key:a,value:b})))},image_whitelist:["jpg","jpeg","gif","png","svg"],load:function(a,b,c,d){function e(){var a=this.src;this.removeEventListener&&this.removeEventListener("canplaythrough",e,!1),++l,c&&c({loaded:l,total:k,percent:l/k*100,src:a}),l===k&&b&&b()}function f(){var a=this.src;d&&d({loaded:l,total:k,percent:l/k*100,src:a}),l++,l===k&&b&&b()}for(var g,h,i=0,j=a.length,k=j,l=0,m="";i<j;++i){if(g=a[i],m=g.substr(g.lastIndexOf(".")+1,3).toLowerCase(),h=Crafty.asset(g)||null,Crafty.audio.supports(m)){if(!h){var n=g.substr(g.lastIndexOf("/")+1).toLowerCase();h=Crafty.audio.create(n,g).obj}h.addEventListener&&h.addEventListener("canplaythrough",e,!1)}else{if(!(Crafty.image_whitelist.indexOf(m)>=0)){k--;continue}h||(h=new Image,Crafty.asset(g,h)),h.onload=e,h.src="",h.src=g}h.onerror=f}0===k&&b()},modules:function(a,b,c){2===arguments.length&&"object"==typeof a&&(c=b,b=a,a="http://cdn.craftycomponents.com");var d=function(){function a(a,b,c){for(c=0,j=a.length;c<j;++c)if(!b(a[c]))return p;return 1}function b(b,c){a(b,function(a){return!c(a)})}function c(f,g,h){function j(a){return a.call?a():l[a]}function k(){if(!--t){l[s]=1,r&&r();for(var c in n)a(c.split("|"),j)&&!b(n[c],j)&&(n[c]=[])}}f=f[q]?f:[f];var p=g&&g.call,r=p?g:h,s=p?f.join(""):g,t=f.length;return setTimeout(function(){b(f,function(a){return o[a]?(s&&(m[s]=1),2==o[a]&&k()):(o[a]=1,s&&(m[s]=1),void d(!i.test(a)&&e?e+a+".js":a,k))})},0),c}function d(a,b){var c=g.createElement("script"),d=p;c.onload=c.onerror=c[u]=function(){c[s]&&!/^c|loade/.test(c[s])||d||(c.onload=c[u]=null,d=1,o[a]=2,b())},c.async=1,c.src=a,h.insertBefore(c,h.firstChild)}var e,f=this,g=document,h=g.getElementsByTagName("head")[0],i=/^https?:\/\//,k=f.$script,l={},m={},n={},o={},p=!1,q="push",r="DOMContentLoaded",s="readyState",t="addEventListener",u="onreadystatechange";return!g[s]&&g[t]&&(g[t](r,function a(){g.removeEventListener(r,a,p),g[s]="complete"},p),g[s]="loading"),c.get=d,c.order=function(a,b,d){!function e(f){f=a.shift(),a.length?c(f,e):c(f,b,d)}()},c.path=function(a){e=a},c.ready=function(d,e,f){d=d[q]?d:[d];var g=[];return!b(d,function(a){l[a]||g[q](a)})&&a(d,function(a){return l[a]})?e():!function(a){n[a]=n[a]||[],n[a][q](e),f&&f(g)}(d.join("|")),c},c.noConflict=function(){return f.$script=k,this},c}(),e=[],f=/^(https?|file):\/\//;for(var g in b)f.test(g)?e.push(g):e.push(a+"/"+g.toLowerCase()+"-"+b[g].toLowerCase()+".js");d(e,function(){c&&c()})}}),Crafty.math={abs:function(a){return a<0?-a:a},amountOf:function(a,b,c){return b<c?(a-b)/(c-b):(a-c)/(b-c)},clamp:function(a,b,c){return a>c?c:a<b?b:a},degToRad:function(a){return a*Math.PI/180},distance:function(a,b,c,d){var e=Crafty.math.squaredDistance(a,b,c,d);return Math.sqrt(parseFloat(e))},lerp:function(a,b,c){return a+(b-a)*c},negate:function(a){return Math.random()<a?-1:1},radToDeg:function(a){return 180*a/Math.PI},randomElementOfArray:function(a){return a[Math.floor(a.length*Math.random())]},randomInt:function(a,b){return a+Math.floor((1+b-a)*Math.random())},randomNumber:function(a,b){return a+(b-a)*Math.random()},squaredDistance:function(a,b,c,d){return(a-c)*(a-c)+(b-d)*(b-d)},withinRange:function(a,b,c){return a>=b&&a<=c}},Crafty.math.Vector2D=function(){function a(b,c){if(b instanceof a)this.x=b.x,this.y=b.y;else if(2===arguments.length)this.x=b,this.y=c;else if(arguments.length>0)throw"Unexpected number of arguments for Vector2D()"}return a.prototype.x=0,a.prototype.y=0,a.prototype.add=function(a){return this.x+=a.x,this.y+=a.y,this},a.prototype.angleBetween=function(a){return Math.atan2(this.x*a.y-this.y*a.x,this.x*a.x+this.y*a.y)},a.prototype.angleTo=function(a){return Math.atan2(a.y-this.y,a.x-this.x)},a.prototype.clone=function(){return new a(this)},a.prototype.distance=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))},a.prototype.distanceSq=function(a){return(a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y)},a.prototype.divide=function(a){return this.x/=a.x,this.y/=a.y,this},a.prototype.dotProduct=function(a){return this.x*a.x+this.y*a.y},a.prototype.equals=function(b){return b instanceof a&&this.x==b.x&&this.y==b.y},a.prototype.getNormal=function(b){return void 0===b?new a(-this.y,this.x):new a(b.y-this.y,this.x-b.x).normalize()},a.prototype.isZero=function(){return 0===this.x&&0===this.y},a.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},a.prototype.magnitudeSq=function(){return this.x*this.x+this.y*this.y},a.prototype.multiply=function(a){return this.x*=a.x,this.y*=a.y,this},a.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},a.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y);return 0===a?(this.x=1,this.y=0):(this.x/=a,this.y/=a),this},a.prototype.scale=function(a,b){return void 0===b&&(b=a),this.x*=a,this.y*=b,this},a.prototype.scaleToMagnitude=function(a){var b=a/this.magnitude();return this.x*=b,this.y*=b,this},a.prototype.setValues=function(b,c){return b instanceof a?(this.x=b.x,this.y=b.y):(this.x=b,this.y=c),this},a.prototype.subtract=function(a){return this.x-=a.x,this.y-=a.y,this},a.prototype.toString=function(){return"Vector2D("+this.x+", "+this.y+")"},a.prototype.translate=function(a,b){return void 0===b&&(b=a),this.x+=a,this.y+=b,this},a.tripleProduct=function(a,b,c){var d=a.dotProduct(c),e=b.dotProduct(c);return new Crafty.math.Vector2D(b.x*d-a.x*e,b.y*d-a.y*e)},a}(),Crafty.math.Matrix2D=function(){return Matrix2D=function(a,b,c,d,e,f){if(a instanceof Matrix2D)this.a=a.a,this.b=a.b,this.c=a.c,this.d=a.d,this.e=a.e,this.f=a.f;else if(6===arguments.length)this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f;else if(arguments.length>0)throw"Unexpected number of arguments for Matrix2D()"},Matrix2D.prototype.a=1,Matrix2D.prototype.b=0,Matrix2D.prototype.c=0,Matrix2D.prototype.d=1,Matrix2D.prototype.e=0,Matrix2D.prototype.f=0,Matrix2D.prototype.apply=function(a){var b=a.x;return a.x=b*this.a+a.y*this.c+this.e,a.y=b*this.b+a.y*this.d+this.f,a},Matrix2D.prototype.clone=function(){return new Matrix2D(this)},Matrix2D.prototype.combine=function(a){var b=this.a;return this.a=b*a.a+this.b*a.c,this.b=b*a.b+this.b*a.d,b=this.c,this.c=b*a.a+this.d*a.c,this.d=b*a.b+this.d*a.d,b=this.e,this.e=b*a.a+this.f*a.c+a.e,this.f=b*a.b+this.f*a.d+a.f,this},Matrix2D.prototype.equals=function(a){return a instanceof Matrix2D&&this.a==a.a&&this.b==a.b&&this.c==a.c&&this.d==a.d&&this.e==a.e&&this.f==a.f},Matrix2D.prototype.determinant=function(){return this.a*this.d-this.b*this.c},Matrix2D.prototype.invert=function(){var a=this.determinant();if(0!==a){var b={a:this.a,b:this.b,c:this.c,d:this.d,e:this.e,f:this.f};this.a=b.d/a,this.b=-b.b/a,this.c=-b.c/a,this.d=b.a/a,this.e=(b.c*b.f-b.e*b.d)/a,this.f=(b.e*b.b-b.a*b.f)/a}return this},Matrix2D.prototype.isIdentity=function(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d&&0===this.e&&0===this.f},Matrix2D.prototype.isInvertible=function(){return 0!==this.determinant()},Matrix2D.prototype.preRotate=function(a){var b=Math.cos(a),c=Math.sin(a),d=this.a;return this.a=b*d-c*this.b,this.b=c*d+b*this.b,d=this.c,this.c=b*d-c*this.d,this.d=c*d+b*this.d,this},Matrix2D.prototype.preScale=function(a,b){return void 0===b&&(b=a),this.a*=a,this.b*=b,this.c*=a,this.d*=b,this},Matrix2D.prototype.preTranslate=function(a,b){return"number"==typeof a?(this.e+=a,this.f+=b):(this.e+=a.x,this.f+=a.y),this},Matrix2D.prototype.rotate=function(a){var b=Math.cos(a),c=Math.sin(a),d=this.a;return this.a=b*d-c*this.b,this.b=c*d+b*this.b,d=this.c,this.c=b*d-c*this.d,this.d=c*d+b*this.d,d=this.e,this.e=b*d-c*this.f,this.f=c*d+b*this.f,this},Matrix2D.prototype.scale=function(a,b){return void 0===b&&(b=a),this.a*=a,this.b*=b,this.c*=a,this.d*=b,this.e*=a,this.f*=b,this},Matrix2D.prototype.setValues=function(a,b,c,d,e,f){return a instanceof Matrix2D?(this.a=a.a,this.b=a.b,this.c=a.c,this.d=a.d,this.e=a.e,this.f=a.f):(this.a=a,this.b=b,this.c=c,this.d=d,this.e=e,this.f=f),this},Matrix2D.prototype.toString=function(){return"Matrix2D(["+this.a+", "+this.c+", "+this.e+"] ["+this.b+", "+this.d+", "+this.f+"] [0, 0, 1])"},Matrix2D.prototype.translate=function(a,b){return"number"==typeof a?(this.e+=this.a*a+this.c*b,this.f+=this.b*a+this.d*b):(this.e+=this.a*a.x+this.c*a.y,this.f+=this.b*a.x+this.d*a.y),this},Matrix2D}(),Crafty.c("Delay",{init:function(){this._delays=[],this.bind("EnterFrame",function(){for(var a=(new Date).getTime(),b=this._delays.length;--b>=0;){var c=this._delays[b];c.start+c.delay+c.pause<a&&(c.func.call(this),c.repeat>0?(c.start=a,c.pause=0,c.pauseBuffer=0,c.repeat--):c.repeat<=0&&this._delays.splice(b,1))}}),this.bind("Pause",function(){var a=(new Date).getTime();for(var b in this._delays)this._delays[b].pauseBuffer=a}),this.bind("Unpause",function(){var a=(new Date).getTime();for(var b in this._delays){var c=this._delays[b];c.pause+=a-c.pauseBuffer}})},delay:function(a,b,c){return this._delays.push({start:(new Date).getTime(),func:a,delay:b,repeat:(c<0?1/0:c)||0,pauseBuffer:0,pause:0}),this}}),Crafty.c("DebugCanvas",{init:function(){this.requires("2D"),Crafty.DebugCanvas.context||Crafty.DebugCanvas.init(),Crafty.DebugCanvas.add(this),this._debug={alpha:1,lineWidth:1},this.bind("RemoveComponent",this.onDebugRemove),this.bind("Remove",this.onDebugDestroy)},onDebugRemove:function(a){"DebugCanvas"===a&&Crafty.DebugCanvas.remove(this)},onDebugDestroy:function(a){Crafty.DebugCanvas.remove(this)},debugAlpha:function(a){return this._debug.alpha=a,this},debugFill:function(a){return"undefined"==typeof a&&(a="red"),this._debug.fillStyle=a,this},debugStroke:function(a){return"undefined"==typeof a&&(a="red"),this._debug.strokeStyle=a,this},debugDraw:function(a){var b=a.globalAlpha,c=this._debug;c.alpha&&(a.globalAlpha=this._debug.alpha),c.strokeStyle&&(a.strokeStyle=c.strokeStyle),c.lineWidth&&(a.lineWidth=c.lineWidth),c.fillStyle&&(a.fillStyle=c.fillStyle),this.trigger("DebugDraw"),a.globalAlpha=b}}),Crafty.c("DebugRectangle",{init:function(){this.requires("2D, DebugCanvas")},debugRectangle:function(a){return this.debugRect=a,this.unbind("DebugDraw",this.drawDebugRect),this.bind("DebugDraw",this.drawDebugRect),this},drawDebugRect:function(){ctx=Crafty.DebugCanvas.context;var a=this.debugRect;null!==a&&void 0!==a&&a._h&&a._w&&(this._debug.fillStyle&&ctx.fillRect(a._x,a._y,a._w,a._h),
this._debug.strokeStyle&&ctx.strokeRect(a._x,a._y,a._w,a._h))}}),Crafty.c("VisibleMBR",{init:function(){this.requires("DebugRectangle").debugFill("purple").bind("EnterFrame",this._assignRect)},_assignRect:function(){this._mbr?this.debugRectangle(this._mbr):this.debugRectangle(this)}}),Crafty.c("DebugPolygon",{init:function(){this.requires("2D, DebugCanvas")},debugPolygon:function(a){return this.polygon=a,this.unbind("DebugDraw",this.drawDebugPolygon),this.bind("DebugDraw",this.drawDebugPolygon),this},drawDebugPolygon:function(){ctx=Crafty.DebugCanvas.context,ctx.beginPath();for(var a in this.polygon.points)ctx.lineTo(this.map.points[a][0],this.map.points[a][1]);ctx.closePath(),this._debug.fillStyle&&ctx.fill(),this._debug.strokeStyle&&ctx.stroke()}}),Crafty.c("WiredHitBox",{init:function(){this.requires("DebugPolygon").debugStroke("red").matchHitBox()},matchHitBox:function(){this.debugPolygon(this.map)}}),Crafty.c("SolidHitBox",{init:function(){this.requires("Collision, DebugPolygon").debugFill("orange").debugAlpha(.7).matchHitBox()},matchHitBox:function(){this.debugPolygon(this.map)}}),Crafty.DebugCanvas={context:null,entities:[],onetimeEntities:[],add:function(a){this.entities.push(a)},remove:function(a){for(var b=this.entities,c=b.length-1;c>=0;c--)b[c]==a&&b.splice(c,1)},init:function(){if(!Crafty.DebugCanvas.context){if(!Crafty.support.canvas)return Crafty.trigger("NoCanvas"),void Crafty.stop();var a;a=document.createElement("canvas"),a.width=Crafty.viewport.width,a.height=Crafty.viewport.height,a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.id="debug-canvas",a.style.zIndex=1e5,Crafty.stage.elem.appendChild(a),Crafty.DebugCanvas.context=a.getContext("2d"),Crafty.DebugCanvas._canvas=a}Crafty.unbind("RenderScene",Crafty.DebugCanvas.renderScene),Crafty.bind("RenderScene",Crafty.DebugCanvas.renderScene)},renderScene:function(a){var b,a=a||Crafty.viewport.rect(),c=Crafty.DebugCanvas.entities,d=0,e=c.length,f=Crafty.DebugCanvas.context,g=Crafty.viewport;for(f.setTransform(g._scale,0,0,g._scale,g._x,g._y),f.clearRect(a._x,a._y,a._w,a._h);d<e;d++)b=c[d],b.debugDraw(f)}}}),function(){var a,b=function(a,b){return function(){return a.apply(b,arguments)}};a=function(){function a(){this.start=b(this.start,this)}return a.prototype.models={},a.prototype.board=function(){return this._board||(this._board=Crafty.e("Board"))},a.prototype.start=function(){return Crafty.init(this.board().width(),this.board().height()),Crafty.background("Silver"),Crafty.scene("Start"),Crafty.timer.FPS(10)},a}(),window.game=new a,Crafty.c("Board",{init:function(){return this.requires("Model")},map_grid:{width:40,height:40,tile:{width:16,height:16}},grid_width:function(){return this.map_grid.width},grid_height:function(){return this.map_grid.width},width:function(){return this.map_grid.width*this.map_grid.tile.width},height:function(){return this.map_grid.height*this.map_grid.tile.height},last_bottom_block:function(){return this.map_grid.height-1},last_right_block:function(){return this.map_grid.width-1},grid_width:function(){return this.map_grid.tile.width},grid_height:function(){return this.map_grid.tile.width},at:function(a,b,c){var d,e,f,g,h,i,j;for(null==c&&(c="Solid Grid"),j=[],i=Crafty(c),e=0,h=i.length;e<h;e++)f=i[e],g=Crafty(f),d=g.at(),d.x===a&&d.y===b&&j.push(g);return j},taken:function(a,b,c){return null==c&&(c="Solid Grid"),this.at(a,b,c).length>0},borders:function(){var a,b,c,d,e,f,g,h,i,j,k;for(g=[],j=b=0,e=this.last_right_block();0<=e?b<=e:b>=e;j=0<=e?++b:--b)for(k=c=0,f=this.last_bottom_block();0<=f?c<=f:c>=f;k=0<=f?++c:--c)i=0===k,a=k===this.last_bottom_block(),h=j===this.last_right_block(),d=0===j,(i||a||h||d)&&g.push({x:j,y:k});return g}}),Crafty.c("GridCollision",{init:function(){return this.bind("EnterFrame",this.check)},check:function(){}}),Crafty.c("SnakeDirectional",{UP:1,RIGHT:2,DOWN:3,LEFT:4,button_to_direction:{K:1,L:2,J:3,H:4},init:function(){return this.requires("Model, Keyboard"),this.data({direction:this.RIGHT,at:[1,1]}),this.bind("KeyDown",this.change_direction)},remove:function(){return this.unbind("KeyDown",this.change_direction)},change_direction:function(a){var b,c,d;c=this.button_to_direction;for(b in c)if(d=c[b],a.key===Crafty.keys[b])return this.data({direction:d})},next_direction:function(){var a,b;return a=this.data("at"),b=this.data("direction"),b===this.RIGHT?a[0]++:b===this.LEFT?a[0]--:b===this.UP?a[1]--:b===this.DOWN&&a[1]++,a},move_to_next_direction:function(){return this.data({at:this.next_direction()})}}),Crafty.c("Snake",{interval:null,init:function(){return this.requires("Model, SnakeDirectional, GridCollision"),this.data({pieces:[],last_piece:0}),this.bind("EnterFrame",this.move_snake),this.add_piece()},remove:function(){return this.unbind("EnterFrame",this.move_snake)},add_piece:function(a){var b;return null==a&&(a=[1,1]),b=Crafty.e("SnakePiece").at(a[0],a[1]),this.data("pieces").push(b)},move_snake:function(){var a;return a=this.data("pieces").shift(),a.at.apply(a,this.next_direction()),this.data("pieces").push(a),this.move_to_next_direction()},hit:function(){},grow:function(){},die:function(){}}),Crafty.c("Block",{init:function(){return this.requires("2D, Solid, Canvas, Grid, Color").color("Gray")}}),Crafty.c("Borders",{board:game.board(),init:function(){var a,b,c,d,e;for(d=this.board.borders(),e=[],a=0,b=d.length;a<b;a++)c=d[a],e.push(Crafty.e("Block").at(c.x,c.y));return e}}),Crafty.c("Grid",{init:function(){var a;return a=game.board(),this.attr({w:a.grid_width(),h:a.grid_height()})},at:function(a,b){var c;return c=game.board(),null!=a&&null!=b?(this.attr({x:a*c.grid_width(),y:b*c.grid_height()}),this):{x:this.x/c.grid_width(),y:this.y/c.grid_height()}}}),Crafty.c("Model",{init:function(){return this.defaults=this.defaults||{},this.attributes=this.extend.call(this.attributes||{},this.defaults),this.original=this.attributes,this.changed=this.changed||[],this.bind("DataChange",this._changed_attributes),this.bind("DataChange",this._changed_triggers)},setup:function(a){return this.set.apply(this,a,{silent:!0}),this},_changed_triggers:function(a,b){var c,d;b=Crafty.extend.call({pre:""},b),d=[];for(c in a)this.trigger("DataChange["+b.pre+c+"]",a[c]),"Object"===a[c].constructor.name?d.push(this._changed_triggers(a[c],{pre:b.pre+c+"."})):d.push(void 0);return d},_changed_attributes:function(a){var b;for(b in a)this.changed.push(b);return this},data:function(){return 1===arguments.length&&"string"==typeof arguments[0]?this.get.apply(this,arguments):this.set.apply(this,arguments)},get:function(a,b){var c,d,e;return"undefined"!=typeof b&&null!==b||(b=this.attributes),a.indexOf(".")>-1?(d=a.split("."),c=d.shift(),e=d.join("."),this.get(d.join("."),b[c])):b[a]||null},set:function(){var a,b,c;return a=this._set_normalize_arguments.apply(this,arguments),c=a.options,b=a.data,c=Crafty.extend.call({recursive:"string"==typeof arguments[0]&&arguments[0].indexOf(".")>-1,silent:!1},c),c.silent||this.trigger("DataChange",b),c.recursive?this.attributes=this._recursive_extend(b,this.attributes):this.extend.call(this.attributes,b),this},_set_normalize_arguments:function(){var a,b,c;return b=arguments.length,3===b||2===b&&"string"==typeof arguments[0]?(a=this._set_create_object.apply(this,arguments),c=arguments[2]||{}):(a=arguments[0]||{},c=arguments[1]||{}),{data:a,options:c}},_set_create_object:function(a,b){var c,d,e,f;return c={},a.indexOf(".")>-1?(e=a.split("."),d=e.shift(),f=e.join("."),c[d]=this._set_create_object(f,b)):c[a]=b,c},_recursive_extend:function(a,b){var c;for(c in a)"Object"===a[c].constructor.name?b[c]=this._recursive_extend(a[c],b[c]):b[c]=a[c];return b},is_dirty:function(a){return 0===arguments.length?!!this.changed.length:this.changed.indexOf(a)>-1}}),Crafty.extend({m:function(a){return this.e(a+", Model")}}),Crafty.c("Popup",{popups:[],component:"Food",board:null,init:function(){return this.board=game.board()},delete:function(){var a,b,c,d;for(d=[],a=0,b=popups.length;a<b;a++)c=popups[a],d.push(c.destroy());return d},create:function(a,b){return Crafty.c(this.component).at(a,b)},pick_location:function(){for(var a,b;;)if(a=Crafty.math.randomInt(0,this.board.grid_width()),b=Crafty.math.randomInt(0,this.board.grid_height()),!game.taken(a,b))return{x:a,y:b}},popup:function(){return this.delete(),create.apply(this,pick_location())}}),Crafty.c("SnakePiece",{init:function(){return this.requires("DOM, 2D, Color, Grid, Solid").color("Green")}}),Crafty.c("Subtitle",{init:function(){return this.requires("DOM, 2D, Text, Grid").textFont({size:"20px"}).css({"text-align":"center"}).attr({w:game.board().width()})}}),Crafty.c("Title",{init:function(){return this.requires("DOM, 2D, Text, Grid").textFont({size:"25px"}).css({"text-align":"center"}).attr({w:game.board().width()})}}),Crafty.scene("GameOver",function(){return Crafty.e("Borders"),Crafty.e("Title").at(0,5).text("Game Over!"),Crafty.e("Subtitle").at(0,10).text("Total Points: x"),Crafty.e("Subtitle").at(0,12).text("Press any key to continue"),Crafty.e("Keyboard").one("KeyDown",function(){return Crafty.scene("Game")})}),Crafty.scene("Game",function(){var a;return Crafty.e("Borders"),a=Crafty.e("Snake"),a.one("Die",function(){return Crafty.scene("GameOver")})}),Crafty.scene("Start",function(){return Crafty.e("Borders"),Crafty.e("Title").at(0,5).text("Crafty Snake"),Crafty.e("Subtitle").at(0,10).text("Press any key to continue"),Crafty.e("Subtitle").at(0,12).text("H, J, K, L"),Crafty.e("Keyboard").one("KeyDown",function(){return Crafty.scene("Game")})})}.call(this);